{# 1件分の購入カード。order と mode('mine'|'received') を受け取る #}
<div class="card purch-card border-0 shadow-sm">
  <div class="card-body d-flex gap-3 align-items-start">

    {# サムネイル #}
    <a class="flex-shrink-0" href="{% url 'frontend:product_detail' order.product.id %}">
      <div class="thumb bg-light overflow-hidden">
        {% if order.product.image_url %}
          <img src="{{ order.product.image_url }}" class="w-100 h-100" style="object-fit:cover;" alt="">
        {% else %}
          <div class="noimg">No Image</div>
        {% endif %}
      </div>
    </a>

    {# 本文 #}
    <div class="flex-grow-1">
      <div class="d-flex align-items-start justify-content-between">
        <div>
          <a href="{% url 'frontend:product_detail' order.product.id %}" class="text-decoration-none text-dark">
            <div class="fw-bold text-truncate">
              {{ order.product.title|default:order.product_title }}
            </div>
          </a>
          <div class="text-muted small">
            {% if mode == 'mine' %}
              販売者: {{ order.product.owner.username|default:"-" }}
            {% else %}
              購入者: {{ order.buyer.username|default:"-" }}
            {% endif %}
          </div>
        </div>

        {# ステータスピル #}
        <div class="ms-2">
            {% with st=order.status %}
            {% if st == 'REQUESTED' or st == '申請中' %}
                <span class="badge text-bg-secondary">申請中</span>
            {% elif st == 'SHIPPED' or st == '発送済み' %}
                <span class="badge text-bg-info">発送済み</span>
            {% elif st == 'COMPLETED' or st == '完了' %}
                <span class="badge text-bg-success">完了</span>
            {% elif st == 'CANCELED' or st == 'キャンセル' %}
                <span class="badge text-bg-light text-muted">キャンセル</span>
            {% else %}
                <span class="badge text-bg-light text-muted">{{ st }}</span>
            {% endif %}
            {% endwith %}
        </div>
      </div>

      {# 価格/数量 #}
      <div class="mt-1 small text-muted">
        数量: {{ order.quantity|default:1 }}
        {% if order.unit_price %}
          ・ 単価: ¥{{ order.unit_price|floatformat:0 }}
        {% elif order.product.price_buy %}
          ・ 参考単価: ¥{{ order.product.price_buy|floatformat:0 }}
        {% endif %}
        {% if order.total_price %}
          ・ 合計: ¥{{ order.total_price|floatformat:0 }}
        {% endif %}
      </div>

      {# 追跡番号（あれば） #}
      {% if order.tracking_number %}
        <div class="mt-1 small text-muted">追跡番号: {{ order.tracking_number }}</div>
      {% endif %}

      {# --- アクション --- #}
            <div class="mt-3 d-flex gap-2 flex-wrap">
            {% with st=order.status %}

            {# 出品者側：申請中 → 発送 or キャンセル #}
            {% if mode == 'received' %}
            {% if st == 'REQUESTED' or st == '申請中' %}
                <form method="post" action="{% url 'frontend:received_purchases' %}"
                    class="d-flex gap-2 align-items-center">
                {% csrf_token %}
                <input type="hidden" name="purchase_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="ship">
                <input type="text" name="tracking_number"
                        class="form-control form-control-sm" placeholder="追跡番号" style="width:160px;">
                <button type="submit" class="btn btn-sm btn-dark">発送する</button>
                </form>

                <form method="post" action="{% url 'frontend:received_purchases' %}">
                {% csrf_token %}
                <input type="hidden" name="purchase_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="cancel">
                <button type="submit" class="btn btn-sm btn-outline-secondary">キャンセル</button>
                </form>
            {% endif %}
            {% endif %}

            {# 購入者側：発送済み → 受取完了 #}
            {% if mode == 'mine' %}
            {% if st == 'SHIPPED' or st == '発送済み' %}
                <form method="post" action="{% url 'frontend:my_purchases' %}">
                {% csrf_token %}
                <input type="hidden" name="purchase_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="complete">
                <button type="submit" class="btn btn-sm btn-dark">受取完了</button>
                </form>
            {% endif %}

            {# 購入者側：申請中 → キャンセル #}
            {% if st == 'REQUESTED' or st == '申請中' %}
                <form method="post" action="{% url 'frontend:my_purchases' %}">
                {% csrf_token %}
                <input type="hidden" name="purchase_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="cancel">
                <button type="submit" class="btn btn-sm btn-outline-secondary">キャンセル</button>
                </form>
            {% endif %}
            {% endif %}

            {% endwith %}
        </div>
    </div>
  </div>
</div>
