{% load humanize %}
{# 1件分の購入カード: 変数 order, mode('mine'|'received') #}
<div class="card border-0 shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start gap-3">
      <div class="d-flex align-items-center gap-3 flex-grow-1">
        <a class="flex-shrink-0" href="{% url 'frontend:product_detail' order.product_id %}">
          <div class="bg-light rounded-2 overflow-hidden" style="width:64px;height:64px;">
            {% if order.product.image_url %}
              <img src="{{ order.product.image_url }}" class="w-100 h-100" style="object-fit:cover;" alt="{{ order.product.title|default:order.product_title }}">
            {% else %}
              <div class="w-100 h-100 d-flex align-items-center justify-content-center small text-muted">No Image</div>
            {% endif %}
          </div>
        </a>
        <div class="fw-semibold">
          <a class="text-decoration-none text-dark" href="{% url 'frontend:product_detail' order.product_id %}">
            {{ order.product.title|default:order.product_title }}
          </a>
        </div>
      </div>
      <div class="text-end">
        {% if order.total_price %}
          <div class="fs-5 fw-bold">\{{ order.total_price|intcomma }}</div>
        {% elif order.unit_price %}
          <div class="fs-5 fw-bold">\{{ order.unit_price|intcomma }}</div>
        {% elif order.product.price_buy %}
          <div class="fs-5 fw-bold">\{{ order.product.price_buy|intcomma }}</div>
        {% endif %}
      </div>
    </div>

    <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
      <span class="badge bg-light text-dark">購入</span>
      {% if order.payment_method %}
        <span class="badge bg-light text-dark">{{ order.payment_method }}</span>
      {% endif %}
      <span class="badge bg-light text-dark">{{ order.quantity|default:1 }}点</span>
      {% with st=order.status %}
        {% if st == 'PENDING' or st == 'REQUESTED' or st == '申請中' %}
          <span class="badge bg-secondary">承認待ち</span>
        {% elif st == 'APPROVED' or st == '承認済み' %}
          <span class="badge bg-primary">承認済み</span>
        {% elif st == 'SHIPPED' or st == '発送済み' %}
          <span class="badge bg-info">発送済み</span>
        {% elif st == 'COMPLETED' or st == '完了' %}
          <span class="badge bg-success">完了</span>
        {% elif st == 'CANCELED' or st == 'キャンセル' %}
          <span class="badge bg-dark">キャンセル</span>
        {% else %}
          <span class="badge bg-secondary">{{ st }}</span>
        {% endif %}
      {% endwith %}
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-6 small">
        <div class="mb-1">
          <span class="text-muted">注文日</span>
          {{ order.created_at|date:"Y年n月j日 H:i" }}
        </div>
        {% if order.tracking_number %}
          <div>
            <span class="text-muted">追跡番号</span>
            {{ order.tracking_number }}
          </div>
        {% endif %}
      </div>
      <div class="col-md-6 small">
        <div class="mb-1">
          <span class="text-muted">{% if mode == 'received' %}購入者{% else %}販売者{% endif %}</span>
          {% if mode == 'received' %}
            {{ order.buyer.email|default:order.buyer.username|default:order.buyer_email }}
          {% else %}
            {{ order.product.owner.email|default:order.product.owner.username|default:order.seller_email }}
          {% endif %}
        </div>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mt-3 align-items-stretch">
      {% with st=order.status %}
        {% if mode == 'received' %}
          {% if st == 'PENDING' or st == 'REQUESTED' or st == '申請中' %}
            <div class="d-flex gap-2 flex-wrap flex-grow-1">
              <form method="post" action="{% url 'frontend:received_purchases' %}" class="m-0 flex-grow-1">
                {% csrf_token %}
                <input type="hidden" name="purchase_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="approve">
                <button type="submit" class="btn btn-primary w-100">承認する</button>
              </form>
              <form method="post" action="{% url 'frontend:received_purchases' %}" class="m-0 flex-grow-1">
                {% csrf_token %}
                <input type="hidden" name="purchase_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="cancel">
                <button type="submit" class="btn btn-outline-danger w-100">キャンセル</button>
              </form>
            </div>
          {% elif st == 'APPROVED' or st == '承認済み' %}
            <form method="post" action="{% url 'frontend:received_purchases' %}" class="m-0 flex-grow-1 d-flex gap-2 flex-wrap">
              {% csrf_token %}
              <input type="hidden" name="purchase_id" value="{{ order.id }}">
              <input type="hidden" name="action" value="ship">
              <input type="text" name="tracking_number" class="form-control flex-grow-1" placeholder="追跡番号" required>
              <button type="submit" class="btn btn-primary">配送する</button>
            </form>
          {% else %}
            <div class="flex-grow-1 small text-muted d-flex align-items-center">
              この注文は<strong class="ms-1">{{ st }}</strong>です。
            </div>
          {% endif %}
        {% else %}
          {% if st == 'APPROVED' or st == 'SHIPPED' or st == '発送済み' %}
            <form method="post" action="{% url 'frontend:my_purchases' %}" class="m-0 flex-grow-1">
              {% csrf_token %}
              <input type="hidden" name="purchase_id" value="{{ order.id }}">
              <input type="hidden" name="action" value="complete">
              <button type="submit" class="btn btn-primary w-100">受取完了</button>
            </form>
          {% elif st == 'PENDING' or st == 'REQUESTED' or st == '申請中' %}
            <div class="flex-grow-1 small text-muted d-flex align-items-center">
              現在、出品者の承認待ちです。
            </div>
            <form method="post" action="{% url 'frontend:my_purchases' %}" class="m-0 flex-grow-1">
              {% csrf_token %}
              <input type="hidden" name="purchase_id" value="{{ order.id }}">
              <input type="hidden" name="action" value="cancel">
              <button type="submit" class="btn btn-outline-danger w-100">キャンセル</button>
            </form>
          {% else %}
            <div class="flex-grow-1 small text-muted d-flex align-items-center">
              この注文は<strong class="ms-1">{{ st }}</strong>です。
            </div>
          {% endif %}
        {% endif %}
      {% endwith %}
    </div>
  </div>
</div>
