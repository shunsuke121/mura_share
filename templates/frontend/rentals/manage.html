{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="container-xxl py-4">
  <h1 class="fw-bold mb-1">ãƒ¬ãƒ³ã‚¿ãƒ«ç®¡ç†</h1>
  <div class="text-muted mb-3">ã‚ãªãŸã®ãƒ¬ãƒ³ã‚¿ãƒ«ç”³è«‹ã¨å—ã‘å–ã£ãŸç”³è«‹ã‚’ç®¡ç†</div>

  {# ã‚¿ãƒ–ï¼ˆè³¼å…¥ç®¡ç†ã®UIã¨åŒã˜è¦‹ãŸç›®ï¼‰ #}
  <div class="btn-group w-100 mb-3" role="group">
    <a class="btn btn-outline-secondary {% if active_tab != 'received' %}active{% endif %}"
       href="{% url 'frontend:my_applications' %}">
      ç§ã®ç”³è«‹ ({{ mine_count|default:0 }})
    </a>
    <a class="btn btn-dark {% if active_tab == 'received' %}active{% endif %}"
       href="{% url 'frontend:rental_manage' %}">
      å—ã‘å–ã£ãŸç”³è«‹ ({{ received_count|default:0 }})
    </a>
  </div>

  {% if applications %}
    <div class="vstack gap-3">
      {% for a in applications %}
        <div class="card border-0 shadow-sm">
          <div class="card-body">

            {# ã‚¿ã‚¤ãƒˆãƒ«ãƒ»é‡‘é¡ #}
            <div class="d-flex justify-content-between align-items-start">
              <div class="fw-semibold">{{ a.product.title }}</div>
              <div class="text-end">
                {% if a.calc_price %}
                  <div class="fs-5 fw-bold">Â¥{{ a.calc_price|intcomma }}</div>
                {% endif %}
                {% if a.calc_days %}
                  <div class="text-muted small">{{ a.calc_days }}æ—¥é–“</div>
                {% endif %}
              </div>
            </div>

            {# ãƒãƒƒã‚¸ #}
            <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
              <span class="badge bg-light text-dark">{{ a.get_order_type_display }}</span>
              {% if a.payment_method %}
                <span class="badge bg-light text-dark">{{ a.get_payment_method_display }}</span>
              {% endif %}
              <span class="badge bg-light text-dark">{{ a.quantity|default:1 }}ç‚¹</span>
              <span class="badge bg-secondary">{{ a.get_status_display|default:a.status }}</span>
            </div>

            {# ä½æ‰€ #}
            <div class="bg-light rounded-2 p-3 my-3">
              <div class="small text-muted">é…é€å…ˆä½æ‰€</div>
              <div>ã€’{{ a.postal_code }} {{ a.address }}</div>
            </div>

            {# æœŸé–“ãƒ»å€Ÿã‚Šæ‰‹ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ #}
            <div class="row g-3">
              <div class="col-md-6 small">
                <div class="mb-1">
                  <span class="text-muted">é–‹å§‹:</span>
                  {% if a.start_date %}{{ a.start_date|date:"Yå¹´næœˆjæ—¥" }}{% else %}-{% endif %}
                </div>
                <div>
                  <span class="text-muted">çµ‚äº†:</span>
                  {% if a.end_date %}{{ a.end_date|date:"Yå¹´næœˆjæ—¥" }}{% else %}-{% endif %}
                </div>
              </div>
              <div class="col-md-6 small">
                <div class="mb-1"><span class="text-muted">å€Ÿã‚Šæ‰‹:</span> {{ a.renter.email|default:a.renter.username }}</div>
                {% if a.message %}
                  <div class="text-muted">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</div>
                  <div class="border rounded p-2 bg-white">{{ a.message }}</div>
                {% endif %}
              </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-3">
              <a class="text-decoration-none" href="{% url 'frontend:product_detail' a.product_id %}">ğŸ‘ è©³ç´°ã‚’è¦‹ã‚‹</a>

              {# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã”ã¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ #}
              {% with s=a.status|lower %}
                {% if s == 'pending' %}
                  <div class="d-flex gap-2">
                    <form method="post" action="{% url 'frontend:rental_app_approve' a.id %}">
                      {% csrf_token %}
                      <button class="btn btn-success">æ‰¿èªã™ã‚‹</button>
                    </form>
                    <form method="post" action="{% url 'frontend:rental_app_reject' a.id %}">
                      {% csrf_token %}
                      <button class="btn btn-outline-danger">å´ä¸‹ã™ã‚‹</button>
                    </form>
                  </div>

                {% elif s == 'approved' %}
                  <form method="post" action="{% url 'frontend:rental_app_ship' a.id %}" class="row g-2 align-items-center">
                    {% csrf_token %}
                    <div class="col-sm-8 col-md-9">
                      <input type="text" name="tracking_number"
                             class="form-control form-control-lg"
                             placeholder="è¿½è·¡ç•ªå·ã‚’å…¥åŠ› (ä¾‹: 1234-5678-9012)">
                    </div>
                    <div class="col-sm-4 col-md-3">
                      <button class="btn btn-primary w-100 btn-lg">é…é€ã™ã‚‹</button>
                    </div>
                  </form>

                {% elif s == 'shipped' %}
                  <div class="text-muted small">
                    å‡ºå“è€…ç™ºé€æ¸ˆã¿ã€‚è¿½è·¡ç•ªå·ï¼š
                    <strong>{{ a.tracking_number|default:"-" }}</strong>
                  </div>

                {% elif s == 'return_shipped' %}
                  <form method="post" action="{% url 'frontend:rental_app_confirm_return' a.id %}" class="w-100">
                    {% csrf_token %}
                    <button class="btn btn-primary w-100">ãƒ¬ãƒ³ã‚¿ãƒ«çµ‚äº†</button>
                  </form>

                {% else %}
                  <div class="text-muted small">ã“ã®ç”³è«‹ã¯<strong>{{ a.get_status_display|default:a.status }}</strong>ã§ã™ã€‚</div>
                {% endif %}
              {% endwith %}
            </div>

            {# è¿”å´ã®è¿½è·¡ç•ªå·ãŒã‚ã‚‹ãªã‚‰è¡¨ç¤ºï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰ #}
            {% if a.return_tracking_number %}
              <div class="mt-2 text-muted small">è¿”å´è¿½è·¡ç•ªå·: {{ a.return_tracking_number }}</div>
            {% endif %}

            <div class="text-muted small mt-2">ç”³è«‹æ—¥: {{ a.created_at|date:"Yå¹´næœˆjæ—¥ H:i" }}</div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center text-muted py-5">å—ã‘å–ã£ãŸç”³è«‹ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
  {% endif %}
</div>
{% endblock %}
