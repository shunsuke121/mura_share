{% extends "base.html" %}
{% load humanize %}

{% block content %}
<div class="container-xxl py-4 rentals">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="fw-bold mb-1">レンタル管理</h2>
      <div class="text-muted">あなたのレンタル申請と受け取った申請を管理</div>
    </div>
  </div>

  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-secondary{% endif %} py-2 mb-2">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="segmented mb-4">
    <a class="seg-btn {% if active_tab != 'received' %}active{% endif %}"
       href="{% url 'frontend:my_applications' %}">
      私の申請 ({{ mine_count|default:0 }})
    </a>
    <a class="seg-btn {% if active_tab == 'received' %}active{% endif %}"
       href="{% url 'frontend:rental_manage' %}">
      受け取った申請 ({{ received_count|default:0 }})
    </a>
  </div>

  {% if applications %}
    <div class="vstack gap-3">
      {% for a in applications %}
        <div class="card border-0 shadow-sm">
          <div class="card-body">

            <!-- 見出し + 料金/日数 -->
            <div class="d-flex justify-content-between align-items-start">
              <div class="fw-semibold">{{ a.product.title }}</div>
              <div class="text-end">
                {% if a.calc_price %}<div class="fs-5 fw-bold">¥{{ a.calc_price|intcomma }}</div>{% endif %}
                {% if a.calc_days %}<div class="text-muted small">{{ a.calc_days }}日間</div>{% endif %}
              </div>
            </div>

            <!-- バッジ -->
            <div class="d-flex align-items-center gap-2 mt-2">
              <span class="badge bg-light text-dark">
                {% if a.order_type == 'rental' %}レンタル{% else %}購入{% endif %}
              </span>
              {% if a.payment_method %}<span class="badge bg-light text-dark">{{ a.get_payment_method_display|default:a.payment_method }}</span>{% endif %}
              <span class="badge bg-light text-dark">{{ a.quantity|default:1 }}点</span>
            </div>

            <!-- 期間/オーナー/メッセージ -->
            <div class="row g-3">
              <div class="col-md-6 small">
                <div class="mb-1"><span class="text-muted">開始:</span> {% if a.start_date %}{{ a.start_date|date:"Y年n月j日" }}{% else %}-{% endif %}</div>
                <div><span class="text-muted">終了:</span> {% if a.end_date %}{{ a.end_date|date:"Y年n月j日" }}{% else %}-{% endif %}</div>
              </div>
              <div class="col-md-6 small">
                <div class="mb-1"><span class="text-muted">オーナー:</span> {{ a.owner.email }}</div>
                {% if a.message %}
                  <div class="text-muted">メッセージ:</div>
                  <div class="border rounded p-2 bg-white">{{ a.message }}</div>
                {% endif %}
              </div>
            </div>

            <!-- アクション行（左：詳細 / 右：状態に応じてボタン） -->
            <div class="d-flex gap-3 mt-3">
              <a class="btn btn-outline-secondary flex-grow-1"
                 href="{% url 'frontend:product_detail' a.product_id %}">
                詳細を見る
              </a>

              {% with s=a.status|lower %}
                {# 1) 出品者が配送済み → 借り手に「レンタル開始」 #}
                {% if s == 'shipped' %}
                  <form method="post"
      action="{% url 'frontend:rental_app_receive' a.id %}"
      class="m-0 flex-grow-1">
  {% csrf_token %}
  <button class="btn btn-primary w-100">レンタル開始</button>
</form>


                {# 2) 借り手が受取完了（レンタル中） → 「返却する」 #}
                {% elif s == 'received' or s == 'renting' %}
                  <form method="post"
                        action="{% url 'frontend:rental_app_return_ship' a.id %}"
                        class="m-0 d-flex gap-2 flex-grow-1">
                    {% csrf_token %}
                    <input type="text" name="return_tracking_number"
                           class="form-control" placeholder="返却の追跡番号">
                    <button class="btn btn-primary">返却する</button>
                  </form>

                {# 3) それ以外（申請中/承認） → キャンセル可、それ以外は無効 #}
                {% else %}
                  <form method="post"
                        action="{% url 'frontend:rental_app_cancel' a.id %}"
                        class="m-0 flex-grow-1">
                    {% csrf_token %}
                    <button class="btn btn-outline-danger w-100"
                      {% if s != 'pending' and s != 'approved' %}disabled{% endif %}>
                      キャンセル
                    </button>
                  </form>
                {% endif %}
              {% endwith %}
            </div>

          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-5 empty-state">
      <div class="empty-title">申請はありません</div>
      <div class="empty-sub">気になる商品をレンタルしてみましょう。</div>
    </div>
  {% endif %}
</div>
{% endblock %}
