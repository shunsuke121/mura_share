{% extends "base.html" %}
{% load static %}
{% block title %}å•†å“ä¸€è¦§ - MURAã‚·ã‚§ã‚¢{% endblock %}

{% block content %}
<style>
.product-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(240px,1fr)); gap:14px; }
.product-card{ border:0; border-radius:14px; box-shadow:0 2px 10px rgba(15,23,42,.06); overflow:hidden; background:#fff; }
.product-card .thumb{ width:100%; aspect-ratio:1/1; background:#f8fafc; overflow:hidden; }
.product-card .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
.pc-body{ padding:.6rem .6rem .75rem; }
.pc-title{ font-weight:700; font-size:.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.pc-cat{ color:#6b7280; font-size:.8rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.pc-desc{ color:#6b7280; font-size:.8rem; margin-top:.2rem; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
.pc-price{ font-weight:700; font-size:.9rem; }
.pc-price-sub{ color:#6b7280; font-size:.8rem; }
.pc-meta{ color:#6b7280; font-size:.78rem; }
.pc-icons{ display:flex; gap:.9rem; color:#6b7280; font-size:1rem; }
.pc-icons .bi{ vertical-align:middle; }
.fav-btn{ cursor:pointer; }
.fav-btn:focus{ outline:none; }
</style>


<form id="filters" method="get" class="row g-2 align-items-center">
  <div class="col-auto" style="min-width:220px;">
    <input
      type="search"
      name="q"
      class="form-control form-control-sm"
      placeholder="å•†å“åãƒ»èª¬æ˜ã§æ¤œç´¢"
      value="{{ selected.q }}"
      oninput="debounceSubmit(this.form)"
      inputmode="search"
      autocomplete="off">
  </div>

  <div class="col-auto">
    <select name="category" class="form-select form-select-sm" onchange="this.form.requestSubmit()">
      <option value="all" {% if selected.category == 'all' %}selected{% endif %}>ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼</option>
      <option {% if selected.category == 'é›»å­æ©Ÿå™¨' %}selected{% endif %}>é›»å­æ©Ÿå™¨</option>
      <option {% if selected.category == 'å®¶å…·' %}selected{% endif %}>å®¶å…·</option>
      <option {% if selected.category == 'ã‚¹ãƒãƒ¼ãƒ„ç”¨å“' %}selected{% endif %}>ã‚¹ãƒãƒ¼ãƒ„ç”¨å“</option>
      <option {% if selected.category == 'æ¥½å™¨' %}selected{% endif %}>æ¥½å™¨</option>
      <option {% if selected.category == 'è»Šä¸¡' %}selected{% endif %}>è»Šä¸¡</option>
      <option {% if selected.category == 'ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢ç”¨å“' %}selected{% endif %}>ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢ç”¨å“</option>
      <option {% if selected.category == 'ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³' %}selected{% endif %}>ãƒ•ã‚¡ãƒƒã‚·ãƒ§ãƒ³</option>
      <option {% if selected.category == 'æ›¸ç±ãƒ»ãƒ¡ãƒ‡ã‚£ã‚¢' %}selected{% endif %}>æ›¸ç±ãƒ»ãƒ¡ãƒ‡ã‚£ã‚¢</option>
      <option {% if selected.category == 'ãã®ä»–' %}selected{% endif %}>ãã®ä»–</option>
    </select>
  </div>

  <div class="col-auto">
    <select name="availability" class="form-select form-select-sm" onchange="this.form.requestSubmit()">
      <option value="all" {% if selected.availability == 'all' %}selected{% endif %}>ã™ã¹ã¦</option>
      <option {% if selected.availability == 'ãƒ¬ãƒ³ã‚¿ãƒ«ã®ã¿' %}selected{% endif %}>ãƒ¬ãƒ³ã‚¿ãƒ«ã®ã¿</option>
      <option {% if selected.availability == 'è²©å£²ã®ã¿' %}selected{% endif %}>è²©å£²ã®ã¿</option>
      <option {% if selected.availability == 'ãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»è²©å£²ä¸¡æ–¹' %}selected{% endif %}>ãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»è²©å£²ä¸¡æ–¹</option>
    </select>
  </div>

  <div class="col-auto ms-auto">
    <select name="sort" class="form-select form-select-sm" onchange="this.form.requestSubmit()">
      <option value="newest"     {% if selected.sort == 'newest' %}selected{% endif %}>æ–°ç€é †</option>
      <option value="price_low"  {% if selected.sort == 'price_low' %}selected{% endif %}>ä¾¡æ ¼ãŒå®‰ã„é †</option>
      <option value="price_high" {% if selected.sort == 'price_high' %}selected{% endif %}>ä¾¡æ ¼ãŒé«˜ã„é †</option>
    </select>
  </div>
</form>

<div class="container-xxl py-3">
  {% if products %}
    <div class="product-grid">
  {% for p in products %}
    <div class="product-card">
      <a href="{% url 'frontend:product_detail' p.id %}">
        <div class="thumb">
          {% if p.image_url %}
            <img src="{{ p.image_url }}" alt="{{ p.title }}">
          {% else %}
            <div class="w-100 h-100 d-flex align-items-center justify-content-center text-muted fs-1">ğŸ“¦</div>
          {% endif %}
        </div>
      </a>

      <div class="pc-body">
        <div class="d-flex justify-content-between mb-1">
          <div class="pc-icons">
            <button type="button" class="fav-btn btn p-0 border-0 bg-transparent"
                    data-pid="{{ p.id }}"
                    aria-pressed="{% if p.is_favorited %}true{% else %}false{% endif %}">
              <i data-icon="heart" class="bi {% if p.is_favorited %}bi-heart-fill text-danger{% else %}bi-heart{% endif %}"></i>
            </button>
            <i class="bi bi-chat"></i>
          </div>
          {% if p.is_sold_out %}
            <div class="pc-meta text-danger fw-semibold">sold out</div>
          {% elif p.available_quantity or p.stock_quantity %}
            <div class="pc-meta">åœ¨åº« {{ p.available_quantity|default:0 }}{% if p.stock_quantity %}/{{ p.stock_quantity }}{% endif %}</div>
          {% endif %}
        </div>
        <div class="pc-title mt-1">{{ p.title }}</div>
        {% if p.price_per_day %}<div class="pc-price">Â¥{{ p.price_per_day|floatformat:0 }}/æ—¥</div>{% endif %}
        {% if p.price_buy %}<div class="pc-price-sub">è²©å£² Â¥{{ p.price_buy|floatformat:0 }}</div>{% endif %}
        
        {% if p.category %}<div class="pc-cat">{{ p.category }}</div>{% endif %}
        {% if p.description %}<div class="pc-desc">{{ p.description|striptags }}</div>{% endif %}
      </div>
    </div>
  {% endfor %}
</div>
  {% else %}
    <div class="text-center py-5">å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>
  {% endif %}
</div>

<script>
(function(){
  // CSRF
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrftoken = getCookie('csrftoken');

  // ã„ã„ã­ãƒˆã‚°ãƒ«
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.fav-btn');
    if (!btn) return;

    // aã‚¿ã‚°ã«å¸ã‚ã‚Œãªã„ã‚ˆã†æ­¢ã‚ã‚‹
    e.preventDefault(); e.stopPropagation();

    const pid = btn.getAttribute('data-pid');
    if (!pid) return;

    try {
      const res = await fetch(`/products/${pid}/favorite/toggle/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRFToken': csrftoken,
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      const ct = res.headers.get('content-type') || '';
      if (!ct.includes('application/json')) {
        location.href = '/login/?next=' + encodeURIComponent(location.pathname + location.search);
        return;
      }

      const data = await res.json();
      if (!data.ok) return;

      const icon = btn.querySelector('[data-icon="heart"]') || btn.querySelector('i');
      if (!icon) return;

      if (data.favorited) {
        btn.setAttribute('aria-pressed','true');
        icon.classList.remove('bi-heart');
        icon.classList.add('bi-heart-fill','text-danger');
      } else {
        btn.setAttribute('aria-pressed','false');
        icon.classList.remove('bi-heart-fill','text-danger');
        icon.classList.add('bi-heart');

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã«å±…ã‚‹å ´åˆã ã‘ã‚«ãƒ¼ãƒ‰å‰Šé™¤
        const card = btn.closest('.product-card');   // â† .card ã§ã¯ãªã .product-card
        const favSection = document.querySelector('[data-favorites-list]');
        if (card && favSection) card.remove();
      }
    } catch(err){
      console.error(err);
    }
  });
})();
</script>
{% endblock %}
