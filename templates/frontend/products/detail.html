{% extends "base.html" %}

{% block title %}商品詳細 - MURA SHARE{% endblock %}

{% block content %}

{% if messages %}
  <div class="mb-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags|default:'info' }} mb-2" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<a class="btn btn-ghost btn-sm mb-3" href="{% url 'frontend:products' %}">
  <i class="bi bi-arrow-left me-1"></i>一覧へ戻る
</a>

<div class="ms-detail-grid">
  <div>
    <div class="ms-gallery">
      <div class="ms-gallery-main">
        {% if images and images.0.image %}
          <img id="main-product-image" src="{{ images.0.image.url }}" class="w-100 h-100 object-fit-cover" alt="{{ product.title }}">
        {% elif product.image_url %}
          <img id="main-product-image" src="{{ product.image_url }}" class="w-100 h-100 object-fit-cover" alt="{{ product.title }}">
        {% else %}
          <div class="w-100 h-100 d-flex align-items-center justify-content-center text-muted">画像がありません</div>
        {% endif %}
      </div>

      {% if images %}
        <div class="ms-gallery-thumbs">
          {% for img in images %}
            {% if img.image %}
              <button type="button"
                      class="ms-gallery-thumb"
                      data-main-src="{{ img.image.url }}"
                      aria-label="画像を切り替え">
                <img src="{{ img.image.url }}" class="w-100 h-100" style="object-fit:cover;" alt="{{ product.title }}">
              </button>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="ms-panel mt-3">
      <div class="ms-kicker">{{ product.category }}</div>
      <h2 class="mb-1">{{ product.title }}</h2>
      <div class="ms-muted small">{{ product.availability_type }}</div>

      <div class="mt-3">
        {% if product.price_per_day %}
          <div class="pc-price">レンタル \{{ product.price_per_day|floatformat:0 }} / 日</div>
        {% endif %}
        {% if product.price_buy %}
          <div class="pc-price">購入 \{{ product.price_buy|floatformat:0 }}</div>
        {% endif %}
        {% if not product.price_per_day and not product.price_buy %}
          <div class="ms-muted">価格未設定</div>
        {% endif %}
      </div>

      <div class="pc-tags mt-3">
        <span class="ms-chip">状態: {{ product.condition }}</span>
        {% if product.is_sold_out %}
          <span class="ms-chip is-hot">SOLD OUT</span>
        {% elif product.stock_quantity %}
          <span class="ms-chip">在庫 {{ product.available_quantity|default:product.stock_quantity }} / {{ product.stock_quantity }}</span>
        {% endif %}
      </div>

      <div class="ms-divider"></div>
      <h6>商品説明</h6>
      <p>{{ product.description|linebreaksbr }}</p>

      {% if product.owner_notes %}
        <h6 class="mt-3">出品者メモ</h6>
        <p class="ms-muted">{{ product.owner_notes|linebreaksbr }}</p>
      {% endif %}
    </div>
  </div>

  <div>
    <div class="ms-info-card mb-3">
      <div class="d-flex align-items-center gap-3">
        {% if product.owner.profile.profile_image %}
          <img src="{{ product.owner.profile.profile_image.url }}" class="rounded-circle" width="60" height="60" alt="{{ product.owner.username }}">
        {% else %}
          <div class="rounded-circle bg-secondary" style="width:60px;height:60px;"></div>
        {% endif %}
        <div>
          <strong>{{ product.owner.username }}</strong>
          <div class="ms-muted small">出品数 {{ product.owner.products.count }} 件</div>
        </div>
        <div class="ms-auto">
          {% if user.is_authenticated and user.id != product.owner.id %}
            <a href="#comments" class="btn btn-outline-dark btn-sm">コメント</a>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="ms-info-card ms-sticky">
      {% if user.is_authenticated and product.owner.id == user.id %}
        <div class="small ms-muted mb-2">あなたの出品</div>
        <div class="alert alert-secondary py-2 small">
          この商品はあなたの出品です。レンタル・購入の管理は管理画面から行えます。
        </div>
        <div class="d-grid gap-2">
          <a href="{% url 'frontend:my_products' %}" class="btn btn-dark">出品管理へ</a>
          <a href="{% url 'frontend:rental_manage' %}" class="btn btn-outline-secondary">レンタル管理</a>
        </div>
      {% else %}
        {% if product.is_sold_out %}
          <div class="alert alert-secondary py-2 small mb-0">SOLD OUT</div>
        {% else %}
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="m-0">レンタル / 購入</h6>
            <span class="ms-pill">{{ product.availability_type }}</span>
          </div>

          <div class="btn-group w-100 mb-3" role="group" aria-label="order-type">
            {% if product.availability_type != '販売のみ' %}
              <button type="button" class="btn btn-outline-secondary order-tab active" data-mode="rental">レンタル</button>
            {% endif %}
            {% if product.availability_type != 'レンタルのみ' %}
              <button type="button" class="btn btn-outline-secondary order-tab {% if product.availability_type == '販売のみ' %}active{% endif %}" data-mode="purchase">購入</button>
            {% endif %}
          </div>

          <form method="post" action="{% url 'frontend:rental_apply' product.pk %}">
            {% csrf_token %}
            <input type="hidden" id="order_type" name="order_type"
                   value="{% if product.availability_type == '販売のみ' %}purchase{% else %}rental{% endif %}">

            <div class="mb-3">
              <label class="form-label">数量 *</label>
              <input type="number" name="quantity" class="form-control" value="1" min="1" required>
            </div>

            <div id="rental_fields" style="display:{% if product.availability_type == '販売のみ' %}none{% else %}block{% endif %};">
              <div class="mb-3">
                <label class="form-label">レンタル開始日 *</label>
                <input type="date" name="start_date" class="form-control">
                <div class="form-text">発送日より前の日付は選べません。</div>
              </div>
              <div class="mb-3">
                <label class="form-label">レンタル終了日 *</label>
                <input type="date" name="end_date" class="form-control">
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">配送先住所 *</label>
              <div class="row g-2 mb-2">
                <div class="col-6">
                  <input type="text" name="postal_code" id="postal_code" class="form-control" placeholder="郵便番号" inputmode="numeric" autocomplete="postal-code">
                  <div id="postal_help" class="form-text">郵便番号入力で住所が補完されます。</div>
                </div>
              </div>
              <textarea name="address" id="address" rows="2" class="form-control" placeholder="住所" autocomplete="street-address"></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">支払い方法 *</label>
              <select name="payment_method" id="payment_method" class="form-select" required>
                <option value="">選択してください</option>
                <option value="card">クレジットカード</option>
                <option value="convenience">コンビニ</option>
                <option value="paypay">PayPay</option>
                <option value="bank">銀行振込</option>
              </select>
            </div>

            <div id="payment_details" class="mb-3">
              <div class="payment-panel" data-payment="card" style="display:none;">
                <div class="row g-2">
                  <div class="col-md-8">
                    <label class="form-label">カード番号 *</label>
                    <input type="text" name="card_number" class="form-control" inputmode="numeric" autocomplete="cc-number" placeholder="1234 5678 9012 3456">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">有効期限 *</label>
                    <input type="text" name="card_expiry" class="form-control" inputmode="numeric" autocomplete="cc-exp" placeholder="MM/YY">
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-md-8">
                    <label class="form-label">名義 *</label>
                    <input type="text" name="card_name" class="form-control" autocomplete="cc-name" placeholder="TARO YAMADA">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">CVC *</label>
                    <input type="text" name="card_cvc" class="form-control" inputmode="numeric" autocomplete="cc-csc" placeholder="123">
                  </div>
                </div>
              </div>

              <div class="payment-panel" data-payment="convenience" style="display:none;">
                <label class="form-label">電話番号 *</label>
                <input type="text" name="convenience_phone" class="form-control" inputmode="tel" autocomplete="tel" placeholder="09012345678">
                <div class="form-text">通知に必要な番号です。</div>
              </div>

              <div class="payment-panel" data-payment="paypay" style="display:none;">
                <label class="form-label">PayPay登録電話番号 *</label>
                <input type="text" name="paypay_phone" class="form-control" inputmode="tel" autocomplete="tel" placeholder="09012345678">
              </div>

              <div class="payment-panel" data-payment="bank" style="display:none;">
                <div class="row g-2">
                  <div class="col-md-6">
                    <label class="form-label">銀行名 *</label>
                    <input type="text" name="bank_name" class="form-control" placeholder="〇〇銀行">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">支店名 *</label>
                    <input type="text" name="bank_branch" class="form-control" placeholder="本店">
                  </div>
                </div>
                <div class="row g-2 mt-2">
                  <div class="col-md-4">
                    <label class="form-label">口座種別 *</label>
                    <select name="bank_account_type" class="form-select">
                      <option value="">選択</option>
                      <option value="ordinary">普通</option>
                      <option value="current">当座</option>
                    </select>
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">口座番号 *</label>
                    <input type="text" name="bank_account_number" class="form-control" inputmode="numeric" placeholder="1234567">
                  </div>
                </div>
                <div class="mt-2">
                  <label class="form-label">口座名義 *</label>
                  <input type="text" name="bank_account_name" class="form-control" placeholder="ヤマダ タロウ">
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label class="form-label">メッセージ</label>
              <textarea name="message" rows="3" class="form-control" placeholder="出品者への連絡事項"></textarea>
            </div>

            <button type="submit" id="submit_btn" class="btn btn-dark w-100">
              {% if product.availability_type == '販売のみ' %}購入を申し込む{% else %}レンタルを申し込む{% endif %}
            </button>
          </form>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>

<div id="reviews" class="ms-panel mt-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h5 class="mb-0">レビュー</h5>
    <span class="ms-muted small">{{ review_count|default:0 }}件</span>
  </div>
  {% if review_count %}
    {% with avg=average_rating|default:0 %}
      {% with avg_int=avg|floatformat:0|add:"0" %}
        <div class="mb-2 small text-muted">
          平均評価:
          <span class="text-warning">
            {% for _ in "12345"|make_list %}
              {% if forloop.counter <= avg_int %}★{% else %}☆{% endif %}
            {% endfor %}
          </span>
          <span class="ms-1">{{ avg|floatformat:1 }}</span>
        </div>
      {% endwith %}
    {% endwith %}
  {% endif %}
  {% if reviews %}
    <div class="vstack gap-3">
      {% for r in reviews %}
        <div class="border rounded p-2">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold">{{ r.user.profile.display_name|default:r.user.username }}</div>
            <div class="text-muted small">{{ r.created_at|date:"n/j H:i" }}</div>
          </div>
          <div class="mt-1 small text-warning">
            {% for _ in "12345"|make_list %}
              {% if forloop.counter <= r.rating %}★{% else %}☆{% endif %}
            {% endfor %}
          </div>
          {% if r.comment %}
            <div class="mt-1">{{ r.comment|linebreaksbr }}</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="ms-muted">レビューはまだありません。</div>
  {% endif %}
</div>

<div id="comments" class="ms-panel mt-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h5 class="mb-0">コメント</h5>
    <span class="ms-muted small">{{ comments|length }}件</span>
  </div>

  {% if comments %}
    <div class="vstack gap-3">
      {% for c in comments %}
        <div class="border rounded p-2">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold">{{ c.user.profile.display_name|default:c.user.username }}</div>
            <div class="text-muted small">{{ c.created_at|date:"n/j H:i" }}</div>
          </div>
          {% if c.body %}
            <div class="mt-1">{{ c.body|linebreaksbr }}</div>
          {% endif %}
          {% if c.image %}
            <div class="mt-2">
              <img src="{{ c.image.url }}" alt="comment image" class="img-fluid rounded">
            </div>
          {% endif %}
          {% if request.user.is_authenticated and request.user.id == product.owner.id %}
            <form method="post" action="{% url 'frontend:product_comment_delete' product.id c.id %}" class="mt-2 text-end">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger btn-sm"
                      onclick="return confirm('このコメントを削除しますか？');">
                削除
              </button>
            </form>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="ms-muted">コメントはまだありません。</div>
  {% endif %}

  <div class="ms-divider"></div>

  {% if product.is_sold_out %}
    <div class="ms-muted">在庫切れのためコメントできません。</div>
  {% elif user.is_authenticated %}
    <form method="post" action="{% url 'frontend:product_comment_create' product.id %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="mb-2">
        <textarea name="body" class="form-control" rows="3" placeholder="質問や相談を送る"></textarea>
      </div>
      <div class="mb-2">
        <input type="file" name="image" accept="image/*" class="form-control">
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <small class="ms-muted">画像添付も可能です。</small>
        <button type="submit" class="btn btn-dark">コメントする</button>
      </div>
    </form>
  {% else %}
    <div class="ms-muted">
      コメントには <a href="{% url 'frontend:login' %}?next={{ request.get_full_path }}">ログイン</a> が必要です。
    </div>
  {% endif %}
</div>

<script>
(function(){
  const inputs = document.querySelectorAll('input[type="date"][name="start_date"]');
  if (!inputs.length) return;
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const dd = String(now.getDate()).padStart(2, '0');
  const min = `${yyyy}-${mm}-${dd}`;
  inputs.forEach((input) => input.setAttribute('min', min));
})();
</script>

<script>
(function(){
  const tabs = document.querySelectorAll('.order-tab');
  const rentalFields = document.getElementById('rental_fields');
  const orderType = document.getElementById('order_type');
  const submitBtn = document.getElementById('submit_btn');
  if(!tabs.length) return;

  function setMode(mode){
    orderType.value = mode;
    if(mode === 'rental'){
      if(rentalFields) rentalFields.style.display = 'block';
      if(submitBtn) submitBtn.textContent = 'レンタルを申し込む';
    }else{
      if(rentalFields) rentalFields.style.display = 'none';
      if(submitBtn) submitBtn.textContent = '購入を申し込む';
    }
    tabs.forEach(btn => btn.classList.remove('active'));
    const active = Array.from(tabs).find(b => b.dataset.mode === mode);
    if(active) active.classList.add('active');
  }

  tabs.forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode)));
  setMode(orderType ? orderType.value : 'rental');
})();
</script>

<script>
(function(){
  const methodSelect = document.getElementById('payment_method');
  if (!methodSelect) return;

  const panels = Array.from(document.querySelectorAll('#payment_details .payment-panel'));

  function setRequired(panel, isRequired){
    panel.querySelectorAll('input, select').forEach(field => {
      if (isRequired) {
        field.setAttribute('required', 'required');
      } else {
        field.removeAttribute('required');
      }
    });
  }

  function updatePanels(){
    const selected = methodSelect.value;
    panels.forEach(panel => {
      const isActive = panel.getAttribute('data-payment') === selected;
      panel.style.display = isActive ? '' : 'none';
      setRequired(panel, isActive);
    });
  }

  methodSelect.addEventListener('change', updatePanels);
  updatePanels();
})();
</script>

<script>
(function(){
  const main = document.getElementById('main-product-image');
  const thumbs = document.querySelectorAll('[data-main-src]');
  if (!main || !thumbs.length) return;

  function setActive(btn){
    thumbs.forEach(t => t.classList.remove('is-active'));
    btn.classList.add('is-active');
  }

  thumbs.forEach(btn => {
    btn.addEventListener('click', () => {
      const src = btn.getAttribute('data-main-src');
      if (src) {
        main.src = src;
        setActive(btn);
      }
    });
  });

  setActive(thumbs[0]);
})();
</script>

<script>
(function(){
  const zipInput = document.getElementById('postal_code');
  const addrInput = document.getElementById('address');
  const help = document.getElementById('postal_help');
  if (!zipInput || !addrInput) return;

  let lastZip = "";
  let controller = null;

  function setHelp(message, isError){
    if (!help) return;
    help.textContent = message;
    help.classList.toggle("text-danger", !!isError);
    help.classList.toggle("text-muted", !isError);
  }

  function normalizeZip(value){
    return (value || "").replace(/[^0-9]/g, "");
  }

  async function lookup(zip){
    if (zip.length !== 7 || zip === lastZip) return;
    lastZip = zip;
    if (controller) controller.abort();
    controller = new AbortController();
    try {
      setHelp("住所を取得中...", false);
      const res = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${zip}`, {
        signal: controller.signal,
      });
      if (!res.ok) throw new Error("fetch_failed");
      const data = await res.json();
      if (!data || data.status !== 200 || !data.results || !data.results.length) {
        setHelp("住所が見つかりませんでした。", true);
        return;
      }
      const r = data.results[0];
      const address = `${r.address1 || ""}${r.address2 || ""}${r.address3 || ""}`;
      if (address) {
        addrInput.value = address;
        setHelp("住所を自動入力しました。", false);
      }
    } catch (err) {
      if (err.name === "AbortError") return;
      setHelp("住所の取得に失敗しました。", true);
    }
  }

  zipInput.addEventListener("input", () => {
    const zip = normalizeZip(zipInput.value);
    if (zip.length === 7) {
      lookup(zip);
    } else {
      setHelp("郵便番号入力で住所が補完されます。", false);
    }
  });
  zipInput.addEventListener("blur", () => {
    const zip = normalizeZip(zipInput.value);
    if (zip.length === 7) lookup(zip);
  });
})();
</script>

{% endblock %}
