{% extends "base.html" %}

{% block title %}商品詳細 - MURAシェア{% endblock %}

{% block content %}

{# 投稿完了などのメッセージ #}
{% if messages %}
  <div class="mb-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags|default:'info' }} mb-2" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<a class="btn btn-sm btn-outline-secondary mb-3" href="{% url 'frontend:products' %}">← 一覧に戻る</a>

<div class="row g-4">
  {# ===== 左：画像エリア ===== #}
  <div class="col-md-6">
    <div class="ratio ratio-1x1 bg-light rounded d-flex align-items-center justify-content-center">
      {% if images and images.0.image %}
        <img id="main-product-image" src="{{ images.0.image.url }}" class="object-fit-cover rounded w-100 h-100" alt="{{ product.title }}">
      {% elif product.image_url %}
        <img id="main-product-image" src="{{ product.image_url }}" class="object-fit-cover rounded w-100 h-100" alt="{{ product.title }}">
      {% else %}
        <span class="text-muted">画像が登録されていません</span>
      {% endif %}
    </div>

    {% if images %}
      <div class="d-flex gap-2 mt-2 flex-wrap">
        {% for img in images %}
          {% if img.image %}
            <button type="button"
                    class="border rounded overflow-hidden p-0 bg-white"
                    style="width:64px;height:64px;"
                    data-main-src="{{ img.image.url }}"
                    aria-label="画像を切り替える">
              <img src="{{ img.image.url }}" class="w-100 h-100" style="object-fit:cover;" alt="{{ product.title }}">
            </button>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}

    <h2 class="h4 mt-3 mb-1">{{ product.title }}</h2>
    <div class="text-muted small mb-2">
      {{ product.category }} /
      {{ product.availability_type }}
    </div>

    {# 料金表示 #}
    <div class="mb-3">
      {% if product.price_per_day %}
        <div><strong>レンタル：</strong>{{ product.price_per_day|floatformat:0 }} 円 / 日</div>
      {% endif %}
      {% if product.price_buy %}
        <div><strong>販売：</strong>{{ product.price_buy|floatformat:0 }} 円</div>
      {% endif %}
      {% if not product.price_per_day and not product.price_buy %}
        <div class="text-muted">料金情報が未設定です</div>
      {% endif %}
    </div>

    <div class="mb-2">
      <span class="badge bg-light text-dark border">状態：{{ product.condition }}</span>
      {% if product.is_sold_out %}
        <span class="badge bg-danger">sold out</span>
      {% elif product.stock_quantity %}
        <span class="badge bg-light text-dark border">
          在庫：{{ product.available_quantity|default:product.stock_quantity }} / {{ product.stock_quantity }}
        </span>
      {% endif %}
    </div>

    <hr>

    <h6>商品説明</h6>
    <p>{{ product.description|linebreaksbr }}</p>

    {% if product.owner_notes %}
      <h6 class="mt-3">出品者からのひとこと</h6>
      <p class="text-muted">{{ product.owner_notes|linebreaksbr }}</p>
    {% endif %}
  </div>

  {# ===== 右：詳細＋申請フォーム（出し分け） ===== #}
  <div class="col-md-6">

      <!-- オーナー情報 ＆ メッセージボタン -->
  <div class="mb-4 p-3 border rounded bg-white">
    <h5 class="mb-3">オーナー情報</h5>
    <div class="d-flex align-items-center">
      <!-- アイコン：プロフィール画像があれば表示（なければ丸枠） -->
      {% if product.owner.profile.avatar %}
        <img src="{{ product.owner.profile.avatar.url }}" class="rounded-circle" width="60" height="60">
      {% else %}
        <div class="rounded-circle bg-secondary" style="width:60px;height:60px;"></div>
      {% endif %}
      <div class="ms-3">
        <strong>{{ product.owner.username }}</strong><br>
        <small class="text-muted">
          出品数：{{ product.owner.products.count }} 件
        </small>
      </div>
      <div class="ms-auto">
        {% if user.is_authenticated and user.id != product.owner.id %}
          <a href="#comments" class="btn btn-outline-dark">
            コメント
          </a>
        {% endif %}
      </div>
    </div>
  </div>


    {# ================= ここから右側の“申請ボックス” ================= #}
    <div class="card shadow-sm mt-4">
      <div class="card-body">
        {% if user.is_authenticated and product.owner.id == user.id %}
          {# --- オーナー表示 --- #}
          <div class="small text-muted mb-2">あなたの商品</div>
          <div class="alert alert-primary py-2 small">
            これはあなたが投稿した商品です。自分の商品のレンタル・購入はできません。
          </div>
          <div class="d-grid gap-2">
            <a href="{% url 'frontend:my_products' %}" class="btn btn-dark">マイページで管理</a>
            <a href="{% url 'frontend:rental_manage' %}" class="btn btn-outline-primary">レンタル管理を見る</a>
          </div>
        {% else %}
          {# --- 申請フォーム（レンタル/購入の切替） --- #}
          {% if product.is_sold_out %}
            <div class="alert alert-secondary py-2 small mb-0">sold out</div>
          {% else %}
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="m-0">レンタル or 購入</h6>
              <span class="badge bg-light text-dark">
                {% if product.availability_type == 'レンタル・販売両方' %}レンタル・販売両方
                {% elif product.availability_type == 'レンタルのみ' %}レンタルのみ
                {% else %}販売のみ{% endif %}
              </span>
            </div>

            {# タブ #}
            <div class="btn-group w-100 mb-3" role="group" aria-label="order-type">
              {% if product.availability_type != '販売のみ' %}
                <button type="button" class="btn btn-outline-secondary order-tab active" data-mode="rental">レンタル</button>
              {% endif %}
              {% if product.availability_type != 'レンタルのみ' %}
                <button type="button" class="btn btn-outline-secondary order-tab {% if product.availability_type == '販売のみ' %}active{% endif %}" data-mode="purchase">購入</button>
              {% endif %}
            </div>

            <form method="post" action="{% url 'frontend:rental_apply' product.pk %}">
              {% csrf_token %}
              <input type="hidden" id="order_type" name="order_type"
                     value="{% if product.availability_type == '販売のみ' %}purchase{% else %}rental{% endif %}">

              <div class="mb-3">
                <label class="form-label">個数 *</label>
                <input type="number" name="quantity" class="form-control" value="1" min="1" required>
              </div>

              {# レンタル専用フィールド #}
              <div id="rental_fields" style="display:{% if product.availability_type == '販売のみ' %}none{% else %}block{% endif %};">
                <div class="mb-3">
                  <label class="form-label">レンタル開始日 *</label>
                  <input type="date" name="start_date" class="form-control">
                  <div class="form-text">配送時間を考慮して開始日を選んでください。</div>
                </div>
                <div class="mb-3">
                  <label class="form-label">レンタル終了日 *</label>
                  <input type="date" name="end_date" class="form-control">
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">配送先住所 *</label>
                <div class="row g-2 mb-2">
                  <div class="col-6">
                    <input type="text" name="postal_code" id="postal_code" class="form-control" placeholder="郵便番号（ハイフンなし）" inputmode="numeric" autocomplete="postal-code">
                    <div id="postal_help" class="form-text">郵便番号を入力すると住所が自動入力されます。</div>
                  </div>
                </div>
                <textarea name="address" id="address" rows="2" class="form-control" placeholder="住所" autocomplete="street-address"></textarea>
                <div class="form-text">この住所は出品者には開示されません。</div>
              </div>

              <div class="mb-3">
                <label class="form-label">決済方法 *</label>
                <select name="payment_method" id="payment_method" class="form-select" required>
                  <option value="">決済方法を選択</option>
                  <option value="card">クレジットカード</option>
                  <option value="convenience">コンビニ</option>
                  <option value="paypay">PayPay</option>
                  <option value="bank">銀行振込</option>
                </select>
              </div>

              <div id="payment_details" class="mb-3">
                <div class="payment-panel" data-payment="card" style="display:none;">
                  <div class="row g-2">
                    <div class="col-md-8">
                      <label class="form-label">カード番号 *</label>
                      <input type="text" name="card_number" class="form-control"
                             inputmode="numeric" autocomplete="cc-number" placeholder="1234 5678 9012 3456">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">有効期限 *</label>
                      <input type="text" name="card_expiry" class="form-control"
                             inputmode="numeric" autocomplete="cc-exp" placeholder="MM/YY">
                    </div>
                  </div>
                  <div class="row g-2 mt-2">
                    <div class="col-md-8">
                      <label class="form-label">名義 *</label>
                      <input type="text" name="card_name" class="form-control"
                             autocomplete="cc-name" placeholder="TARO YAMADA">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">CVC *</label>
                      <input type="text" name="card_cvc" class="form-control"
                             inputmode="numeric" autocomplete="cc-csc" placeholder="123">
                    </div>
                  </div>
                </div>

                <div class="payment-panel" data-payment="convenience" style="display:none;">
                  <label class="form-label">連絡先電話番号 *</label>
                  <input type="text" name="convenience_phone" class="form-control"
                         inputmode="tel" autocomplete="tel" placeholder="09012345678">
                  <div class="form-text">支払い番号の通知に使用します。</div>
                </div>

                <div class="payment-panel" data-payment="paypay" style="display:none;">
                  <label class="form-label">PayPay登録電話番号 *</label>
                  <input type="text" name="paypay_phone" class="form-control"
                         inputmode="tel" autocomplete="tel" placeholder="09012345678">
                </div>

                <div class="payment-panel" data-payment="bank" style="display:none;">
                  <div class="row g-2">
                    <div class="col-md-6">
                      <label class="form-label">銀行名 *</label>
                      <input type="text" name="bank_name" class="form-control" placeholder="三井住友銀行">
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">支店名 *</label>
                      <input type="text" name="bank_branch" class="form-control" placeholder="渋谷支店">
                    </div>
                  </div>
                  <div class="row g-2 mt-2">
                    <div class="col-md-4">
                      <label class="form-label">口座種別 *</label>
                      <select name="bank_account_type" class="form-select">
                        <option value="">選択</option>
                        <option value="ordinary">普通</option>
                        <option value="current">当座</option>
                      </select>
                    </div>
                    <div class="col-md-8">
                      <label class="form-label">口座番号 *</label>
                      <input type="text" name="bank_account_number" class="form-control"
                             inputmode="numeric" placeholder="1234567">
                    </div>
                  </div>
                  <div class="mt-2">
                    <label class="form-label">口座名義 *</label>
                    <input type="text" name="bank_account_name" class="form-control" placeholder="ヤマダ タロウ">
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">メッセージ（任意）</label>
                <textarea name="message" rows="3" class="form-control" placeholder="オーナーへのメッセージ…"></textarea>
              </div>

              <button type="submit" id="submit_btn" class="btn btn-dark w-100">
                {% if product.availability_type == '販売のみ' %}購入を申請する{% else %}レンタルを申請する{% endif %}
              </button>
            </form>
          {% endif %}
        {% endif %}
      </div>
    </div>
    {# ================= 申請ボックスここまで ================= #}

  </div>
</div>

<div id="comments" class="card shadow-sm mt-4">
  <div class="card-body">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="mb-0">コメント</h5>
      <span class="text-muted small">{{ comments|length }}件</span>
    </div>

    {% if comments %}
      <div class="vstack gap-3">
        {% for c in comments %}
          <div class="border rounded p-2">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-semibold">{{ c.user.profile.display_name|default:c.user.username }}</div>
              <div class="text-muted small">{{ c.created_at|date:"n/j H:i" }}</div>
            </div>
            {% if c.body %}
              <div class="mt-1">{{ c.body|linebreaksbr }}</div>
            {% endif %}
            {% if c.image %}
              <div class="mt-2">
                <img src="{{ c.image.url }}" alt="comment image" class="img-fluid rounded">
              </div>
            {% endif %}
            {% if request.user.is_authenticated and request.user.id == product.owner.id %}
              <form method="post" action="{% url 'frontend:product_comment_delete' product.id c.id %}" class="mt-2 text-end">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger btn-sm"
                        onclick="return confirm('このコメントを削除しますか？');">
                  削除
                </button>
              </form>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-muted">まだコメントはありません。</div>
    {% endif %}

    <hr class="my-3">

    {% if product.is_sold_out %}
      <div class="text-muted">売り切れのためコメントはできません。</div>
    {% elif user.is_authenticated %}
      <form method="post" action="{% url 'frontend:product_comment_create' product.id %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-2">
          <textarea name="body" class="form-control" rows="3" placeholder="購入前の質問・値下げ相談など"></textarea>
        </div>
        <div class="mb-2">
          <input type="file" name="image" accept="image/*" class="form-control">
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">※ 画像のみの投稿も可能です</small>
          <button type="submit" class="btn btn-dark">コメントする</button>
        </div>
      </form>
    {% else %}
      <div class="text-muted">
        コメントするには <a href="{% url 'frontend:login' %}?next={{ request.get_full_path }}">ログイン</a> が必要です。
      </div>
    {% endif %}
  </div>
</div>

{# タブ切替のJS（Bootstrap不要・素朴な切替） #}
<script>
(function(){
  const inputs = document.querySelectorAll('input[type="date"][name="start_date"]');
  if (!inputs.length) return;
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const dd = String(now.getDate()).padStart(2, '0');
  const min = `${yyyy}-${mm}-${dd}`;
  inputs.forEach((input) => input.setAttribute('min', min));
})();
</script>

<script>
(function(){
  const tabs = document.querySelectorAll('.order-tab');
  const rentalFields = document.getElementById('rental_fields');
  const orderType = document.getElementById('order_type');
  const submitBtn = document.getElementById('submit_btn');
  if(!tabs.length) return;

  function setMode(mode){
    orderType.value = mode;
    if(mode === 'rental'){
      if(rentalFields) rentalFields.style.display = 'block';
      if(submitBtn) submitBtn.textContent = 'レンタルを申請する';
    }else{
      if(rentalFields) rentalFields.style.display = 'none';
      if(submitBtn) submitBtn.textContent = '購入を申請する';
    }
    tabs.forEach(btn => btn.classList.remove('active'));
    const active = Array.from(tabs).find(b => b.dataset.mode === mode);
    if(active) active.classList.add('active');
  }

  tabs.forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode)));

  // 初期：hiddenの値に合わせる
  setMode(orderType ? orderType.value : 'rental');
})();
</script>

<script>
(function(){
  const methodSelect = document.getElementById('payment_method');
  if (!methodSelect) return;

  const panels = Array.from(document.querySelectorAll('#payment_details .payment-panel'));

  function setRequired(panel, isRequired){
    panel.querySelectorAll('input, select').forEach(field => {
      if (isRequired) {
        field.setAttribute('required', 'required');
      } else {
        field.removeAttribute('required');
      }
    });
  }

  function updatePanels(){
    const selected = methodSelect.value;
    panels.forEach(panel => {
      const isActive = panel.getAttribute('data-payment') === selected;
      panel.style.display = isActive ? '' : 'none';
      setRequired(panel, isActive);
    });
  }

  methodSelect.addEventListener('change', updatePanels);
  updatePanels();
})();
</script>

<script>
(function(){
  const main = document.getElementById('main-product-image');
  const thumbs = document.querySelectorAll('[data-main-src]');
  if (!main || !thumbs.length) return;

  function setActive(btn){
    thumbs.forEach(t => t.classList.remove('border-primary', 'border-2'));
    btn.classList.add('border-primary', 'border-2');
  }

  thumbs.forEach(btn => {
    btn.addEventListener('click', () => {
      const src = btn.getAttribute('data-main-src');
      if (src) {
        main.src = src;
        setActive(btn);
      }
    });
  });

  setActive(thumbs[0]);
})();
</script>

<script>
(function(){
  const zipInput = document.getElementById('postal_code');
  const addrInput = document.getElementById('address');
  const help = document.getElementById('postal_help');
  if (!zipInput || !addrInput) return;

  let lastZip = "";
  let controller = null;

  function setHelp(message, isError){
    if (!help) return;
    help.textContent = message;
    help.classList.toggle("text-danger", !!isError);
    help.classList.toggle("text-muted", !isError);
  }

  function normalizeZip(value){
    return (value || "").replace(/[^0-9]/g, "");
  }

  async function lookup(zip){
    if (zip.length !== 7 || zip === lastZip) return;
    lastZip = zip;
    if (controller) controller.abort();
    controller = new AbortController();
    try {
      setHelp("住所を取得中...", false);
      const res = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${zip}`, {
        signal: controller.signal,
      });
      if (!res.ok) throw new Error("fetch_failed");
      const data = await res.json();
      if (!data || data.status !== 200 || !data.results || !data.results.length) {
        setHelp("該当する住所が見つかりませんでした。", true);
        return;
      }
      const r = data.results[0];
      const address = `${r.address1 || ""}${r.address2 || ""}${r.address3 || ""}`;
      if (address) {
        addrInput.value = address;
        setHelp("住所を自動入力しました。", false);
      }
    } catch (err) {
      if (err.name === "AbortError") return;
      setHelp("住所の取得に失敗しました。", true);
    }
  }

  zipInput.addEventListener("input", () => {
    const zip = normalizeZip(zipInput.value);
    if (zip.length === 7) {
      lookup(zip);
    } else {
      setHelp("郵便番号を入力すると住所が自動入力されます。", false);
    }
  });
  zipInput.addEventListener("blur", () => {
    const zip = normalizeZip(zipInput.value);
    if (zip.length === 7) lookup(zip);
  });
})();
</script>

{% endblock %}
