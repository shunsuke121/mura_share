{% extends "base.html" %}

{% block title %}å•†å“è©³ç´° - MURAã‚·ã‚§ã‚¢{% endblock %}

{% block content %}

{# æŠ•ç¨¿å®Œäº†ãªã©ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ #}
{% if messages %}
  <div class="mb-3">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags|default:'info' }} mb-2" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}

<a class="btn btn-sm btn-outline-secondary mb-3" href="{% url 'frontend:products' %}">â† ä¸€è¦§ã«æˆ»ã‚‹</a>

<div class="row g-4">
  {# ===== å·¦ï¼šç”»åƒã‚¨ãƒªã‚¢ ===== #}
  <div class="col-md-6">
    <div class="ratio ratio-1x1 bg-light rounded d-flex align-items-center justify-content-center">
      {% if product.image_url %}
        <img src="{{ product.image_url }}" class="object-fit-cover rounded w-100 h-100" alt="{{ product.title }}">
      {% elif images and images.0.image %}
        <img src="{{ images.0.image.url }}" class="object-fit-cover rounded w-100 h-100" alt="{{ product.title }}">
      {% else %}
        <span class="text-muted">ç”»åƒãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</span>
      {% endif %}
    </div>

    {% if images %}
      <div class="d-flex gap-2 mt-2 flex-wrap">
        {% for img in images %}
          <div class="border rounded overflow-hidden" style="width:64px;height:64px;">
            <img src="{{ img.image.url }}" class="w-100 h-100" style="object-fit:cover;" alt="">
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  {# ===== å³ï¼šè©³ç´°ï¼‹ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå‡ºã—åˆ†ã‘ï¼‰ ===== #}
  <div class="col-md-6">
    <h2 class="h4 mb-1">{{ product.title }}</h2>
    <div class="text-muted small mb-2">
      {{ product.category }} /
      {{ product.availability_type }}
    </div>

    {# æ–™é‡‘è¡¨ç¤º #}
    <div class="mb-3">
      {% if product.price_per_day %}
        <div><strong>ãƒ¬ãƒ³ã‚¿ãƒ«ï¼š</strong>{{ product.price_per_day|floatformat:0 }} å†† / æ—¥</div>
      {% endif %}
      {% if product.price_buy %}
        <div><strong>è²©å£²ï¼š</strong>{{ product.price_buy|floatformat:0 }} å††</div>
      {% endif %}
      {% if not product.price_per_day and not product.price_buy %}
        <div class="text-muted">æ–™é‡‘æƒ…å ±ãŒæœªè¨­å®šã§ã™</div>
      {% endif %}
    </div>

    <div class="mb-2">
      <span class="badge bg-light text-dark border">çŠ¶æ…‹ï¼š{{ product.condition }}</span>
      {% if product.is_sold_out %}
        <span class="badge bg-danger">sold out</span>
      {% elif product.stock_quantity %}
        <span class="badge bg-light text-dark border">
          åœ¨åº«ï¼š{{ product.available_quantity|default:product.stock_quantity }} / {{ product.stock_quantity }}
        </span>
      {% endif %}
    </div>

    <hr>

    <h6>å•†å“èª¬æ˜</h6>
    <p>{{ product.description|linebreaksbr }}</p>

    {% if product.owner_notes %}
      <h6 class="mt-3">å‡ºå“è€…ã‹ã‚‰ã®ã²ã¨ã“ã¨</h6>
      <p class="text-muted">{{ product.owner_notes|linebreaksbr }}</p>
    {% endif %}

      <!-- ã‚ªãƒ¼ãƒŠãƒ¼æƒ…å ± ï¼† ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœã‚¿ãƒ³ -->
  <div class="mt-4 p-3 border rounded bg-white">
    <h5 class="mb-3">ã‚ªãƒ¼ãƒŠãƒ¼æƒ…å ±</h5>
    <div class="d-flex align-items-center">
      <!-- ã‚¢ã‚¤ã‚³ãƒ³ï¼šãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãŒã‚ã‚Œã°è¡¨ç¤ºï¼ˆãªã‘ã‚Œã°ä¸¸æ ï¼‰ -->
      {% if product.owner.profile.avatar %}
        <img src="{{ product.owner.profile.avatar.url }}" class="rounded-circle" width="60" height="60">
      {% else %}
        <div class="rounded-circle bg-secondary" style="width:60px;height:60px;"></div>
      {% endif %}
      <div class="ms-3">
        <strong>{{ product.owner.username }}</strong><br>
        <small class="text-muted">
          å‡ºå“æ•°ï¼š{{ product.owner.products.count }} ä»¶
        </small>
      </div>
      <div class="ms-auto">
        {% if user.is_authenticated and user.id != product.owner.id %}
          <a href="{% url 'chat:start_chat' product.id %}" class="btn btn-outline-dark">
            ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          </a>
        {% endif %}
      </div>
    </div>
  </div>


    {# ================= ã“ã“ã‹ã‚‰å³å´ã®â€œç”³è«‹ãƒœãƒƒã‚¯ã‚¹â€ ================= #}
    <div class="card shadow-sm mt-4">
      <div class="card-body">
        {% if user.is_authenticated and product.owner.id == user.id %}
          {# --- ã‚ªãƒ¼ãƒŠãƒ¼è¡¨ç¤º --- #}
          <div class="small text-muted mb-2">ã‚ãªãŸã®å•†å“</div>
          <div class="alert alert-primary py-2 small">
            ã“ã‚Œã¯ã‚ãªãŸãŒæŠ•ç¨¿ã—ãŸå•†å“ã§ã™ã€‚è‡ªåˆ†ã®å•†å“ã®ãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»è³¼å…¥ã¯ã§ãã¾ã›ã‚“ã€‚
          </div>
          <div class="d-grid gap-2">
            <a href="{% url 'frontend:my_products' %}" class="btn btn-dark">ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ç®¡ç†</a>
            <a href="{% url 'frontend:rental_manage' %}" class="btn btn-outline-primary">ãƒ¬ãƒ³ã‚¿ãƒ«ç®¡ç†ã‚’è¦‹ã‚‹</a>
          </div>
        {% else %}
          {# --- ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¬ãƒ³ã‚¿ãƒ«/è³¼å…¥ã®åˆ‡æ›¿ï¼‰ --- #}
          {% if product.is_sold_out %}
            <div class="alert alert-secondary py-2 small mb-0">sold out</div>
          {% else %}
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="m-0">ãƒ¬ãƒ³ã‚¿ãƒ« or è³¼å…¥</h6>
              <span class="badge bg-light text-dark">
                {% if product.availability_type == 'ãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»è²©å£²ä¸¡æ–¹' %}ãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»è²©å£²ä¸¡æ–¹
                {% elif product.availability_type == 'ãƒ¬ãƒ³ã‚¿ãƒ«ã®ã¿' %}ãƒ¬ãƒ³ã‚¿ãƒ«ã®ã¿
                {% else %}è²©å£²ã®ã¿{% endif %}
              </span>
            </div>

            {# ã‚¿ãƒ– #}
            <div class="btn-group w-100 mb-3" role="group" aria-label="order-type">
              {% if product.availability_type != 'è²©å£²ã®ã¿' %}
                <button type="button" class="btn btn-outline-secondary order-tab active" data-mode="rental">ãƒ¬ãƒ³ã‚¿ãƒ«</button>
              {% endif %}
              {% if product.availability_type != 'ãƒ¬ãƒ³ã‚¿ãƒ«ã®ã¿' %}
                <button type="button" class="btn btn-outline-secondary order-tab {% if product.availability_type == 'è²©å£²ã®ã¿' %}active{% endif %}" data-mode="purchase">è³¼å…¥</button>
              {% endif %}
            </div>

            <form method="post" action="{% url 'frontend:rental_apply' product.pk %}">
              {% csrf_token %}
              <input type="hidden" id="order_type" name="order_type"
                     value="{% if product.availability_type == 'è²©å£²ã®ã¿' %}purchase{% else %}rental{% endif %}">

              <div class="mb-3">
                <label class="form-label">å€‹æ•° *</label>
                <input type="number" name="quantity" class="form-control" value="1" min="1" required>
              </div>

              {# ãƒ¬ãƒ³ã‚¿ãƒ«å°‚ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ #}
              <div id="rental_fields" style="display:{% if product.availability_type == 'è²©å£²ã®ã¿' %}none{% else %}block{% endif %};">
                <div class="mb-3">
                  <label class="form-label">ãƒ¬ãƒ³ã‚¿ãƒ«é–‹å§‹æ—¥ *</label>
                  <input type="date" name="start_date" class="form-control">
                  <div class="form-text">é…é€æ™‚é–“ã‚’è€ƒæ…®ã—ã¦é–‹å§‹æ—¥ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</div>
                </div>
                <div class="mb-3">
                  <label class="form-label">ãƒ¬ãƒ³ã‚¿ãƒ«çµ‚äº†æ—¥ *</label>
                  <input type="date" name="end_date" class="form-control">
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">é…é€å…ˆä½æ‰€ *</label>
                <div class="row g-2 mb-2">
                  <div class="col-6">
                    <input type="text" name="postal_code" class="form-control" placeholder="éƒµä¾¿ç•ªå·ï¼ˆãƒã‚¤ãƒ•ãƒ³ãªã—ï¼‰">
                  </div>
                </div>
                <textarea name="address" rows="2" class="form-control" placeholder="ä½æ‰€"></textarea>
                <div class="form-text">ã“ã®ä½æ‰€ã¯å‡ºå“è€…ã«ã¯é–‹ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</div>
              </div>

              <div class="mb-3">
                <label class="form-label">æ±ºæ¸ˆæ–¹æ³• *</label>
                <select name="payment_method" class="form-select" required>
                  <option value="">æ±ºæ¸ˆæ–¹æ³•ã‚’é¸æŠ</option>
                  <option value="card">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</option>
                  <option value="convenience">ã‚³ãƒ³ãƒ“ãƒ‹</option>
                  <option value="paypay">PayPay</option>
                  <option value="bank">éŠ€è¡ŒæŒ¯è¾¼</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label>
                <textarea name="message" rows="3" class="form-control" placeholder="ã‚ªãƒ¼ãƒŠãƒ¼ã¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸â€¦"></textarea>
              </div>

              <button type="submit" id="submit_btn" class="btn btn-dark w-100">
                {% if product.availability_type == 'è²©å£²ã®ã¿' %}è³¼å…¥ã‚’ç”³è«‹ã™ã‚‹{% else %}ãƒ¬ãƒ³ã‚¿ãƒ«ã‚’ç”³è«‹ã™ã‚‹{% endif %}
              </button>
            </form>
          {% endif %}
        {% endif %}
      </div>
    </div>
    {# ================= ç”³è«‹ãƒœãƒƒã‚¯ã‚¹ã“ã“ã¾ã§ ================= #}

  </div>
</div>

<hr class="my-4">

{# ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆæ—¢å­˜ã®éƒ¨å“ã‚’åˆ©ç”¨ï¼‰ #}
{% include "frontend/products/_reviews.html" %}

{# ã‚¿ãƒ–åˆ‡æ›¿ã®JSï¼ˆBootstrapä¸è¦ãƒ»ç´ æœ´ãªåˆ‡æ›¿ï¼‰ #}
<script>
(function(){
  const tabs = document.querySelectorAll('.order-tab');
  const rentalFields = document.getElementById('rental_fields');
  const orderType = document.getElementById('order_type');
  const submitBtn = document.getElementById('submit_btn');
  if(!tabs.length) return;

  function setMode(mode){
    orderType.value = mode;
    if(mode === 'rental'){
      if(rentalFields) rentalFields.style.display = 'block';
      if(submitBtn) submitBtn.textContent = 'ãƒ¬ãƒ³ã‚¿ãƒ«ã‚’ç”³è«‹ã™ã‚‹';
    }else{
      if(rentalFields) rentalFields.style.display = 'none';
      if(submitBtn) submitBtn.textContent = 'è³¼å…¥ã‚’ç”³è«‹ã™ã‚‹';
    }
    tabs.forEach(btn => btn.classList.remove('active'));
    const active = Array.from(tabs).find(b => b.dataset.mode === mode);
    if(active) active.classList.add('active');
  }

  tabs.forEach(btn => btn.addEventListener('click', () => setMode(btn.dataset.mode)));

  // åˆæœŸï¼šhiddenã®å€¤ã«åˆã‚ã›ã‚‹
  setMode(orderType ? orderType.value : 'rental');
})();
</script>

{% endblock %}
