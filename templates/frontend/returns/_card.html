<div class="card purch-card border-0 shadow-sm">
  <div class="card-body d-flex gap-3 align-items-start">
    <a class="flex-shrink-0" href="{% url 'frontend:product_detail' order.product.id %}">
      <div class="thumb bg-light overflow-hidden">
        {% if order.product.image_url %}
          <img src="{{ order.product.image_url }}" class="w-100 h-100" style="object-fit:cover;" alt="">
        {% else %}<div class="noimg">No Image</div>{% endif %}
      </div>
    </a>

    <div class="flex-grow-1">
      <div class="d-flex align-items-start justify-content-between">
        <div>
          <a href="{% url 'frontend:product_detail' order.product.id %}" class="text-decoration-none text-dark">
            <div class="fw-bold text-truncate">{{ order.product.title|default:order.product_title }}</div>
          </a>
          <div class="text-muted small">購入日: {{ order.created_at|date:"Y/m/d H:i" }}</div>
        </div>

        <div class="ms-2">
          {% with rs=order.return_status %}
            {% if rs == 'REQUESTED' %}<span class="badge text-bg-warning">申請中</span>
            {% elif rs == 'APPROVED' %}<span class="badge text-bg-primary">承諾済</span>
            {% elif rs == 'SHIPPED' %}<span class="badge text-bg-info">返送済み</span>
            {% elif rs == 'RECEIVED' %}<span class="badge text-bg-success">返品完了</span>
            {% elif rs == 'REJECTED' %}<span class="badge text-bg-secondary">却下</span>
            {% else %}<span class="badge text-bg-light text-muted">返品可</span>
            {% endif %}
          {% endwith %}
        </div>
      </div>

      <div class="mt-3 d-flex gap-2 flex-wrap">
        {% with rs=order.return_status %}
          {% if mode == 'mine' %}
            {# 1) まだ or 却下後 → 申請ボタン #}
            {% if rs == 'NONE' or rs == 'REJECTED' %}
              <form method="post" action="{% url 'frontend:return_action' %}" class="d-flex gap-2 align-items-center">
                {% csrf_token %}
                <input type="hidden" name="purchase_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="request_return">
                <input type="text" name="reason" class="form-control form-control-sm" placeholder="理由（任意）" style="width: 200px;">
                <button type="submit" class="btn btn-sm btn-dark">返品申請</button>
              </form>
            {% endif %}

            {# 2) 申請中 → 追跡番号は入力不可、メッセージのみ #}
            {% if rs == 'REQUESTED' %}
              <div class="small text-muted">現在、返品先の承諾待ちです。承諾されるまで追跡番号は入力できません。</div>
            {% endif %}

            {# 3) 承諾済 → 追跡番号フォームを解禁 #}
            {% if rs == 'APPROVED' %}
              <form method="post" action="{% url 'frontend:return_action' %}" class="d-flex gap-2 align-items-center">
                {% csrf_token %}
                <input type="hidden" name="purchase_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="ship_back">
                <input type="text" name="tracking_number" class="form-control form-control-sm" placeholder="返送の追跡番号" style="width: 200px;">
                <button type="submit" class="btn btn-sm btn-dark">返送した</button>
              </form>
            {% endif %}

            {# 4) 返送済 → 表示だけ #}
            {% if rs == 'SHIPPED' %}
              <div class="small text-muted">返送中（追跡: {{ order.return_tracking_number }})</div>
            {% endif %}

          {% else %}
            {# 受け取る返品側（出品者） #}
            {% if rs == 'REQUESTED' %}
              <form method="post" action="{% url 'frontend:return_action' %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="purchase_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="approve_return">
                <button type="submit" class="btn btn-sm btn-dark">返品を承諾する</button>
              </form>
              <form method="post" action="{% url 'frontend:return_action' %}" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="purchase_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="reject_return">
                <button type="submit" class="btn btn-sm btn-outline-secondary">返品を却下する</button>
              </form>
              <div class="small text-muted">申請理由: {{ order.return_reason|default:"-" }}</div>
            {% endif %}

            {% if rs == 'APPROVED' %}
              <div class="small text-muted">承諾済み。購入者の返送待ちです。</div>
            {% endif %}

            {% if rs == 'SHIPPED' %}
              <div class="small text-muted">返送の追跡: {{ order.return_tracking_number }}</div>
              <form method="post" action="{% url 'frontend:return_action' %}">
                {% csrf_token %}
                <input type="hidden" name="purchase_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="receive_back">
                <button type="submit" class="btn btn-sm btn-dark">受領完了</button>
              </form>
            {% endif %}
          {% endif %}
        {% endwith %}
      </div>
    </div>
  </div>
</div>
