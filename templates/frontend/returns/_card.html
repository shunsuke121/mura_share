{% load humanize %}
<div class="card border-0 shadow-sm">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-start gap-3">
      <div class="d-flex align-items-center gap-3 flex-grow-1">
        <a class="flex-shrink-0" href="{% url 'frontend:product_detail' order.product_id %}">
          <div class="bg-light rounded-2 overflow-hidden" style="width:64px;height:64px;">
            {% if order.product.image_url %}
              <img src="{{ order.product.image_url }}" class="w-100 h-100" style="object-fit:cover;" alt="{{ order.product.title|default:order.product_title }}">
            {% else %}
              <div class="w-100 h-100 d-flex align-items-center justify-content-center small text-muted">No Image</div>
            {% endif %}
          </div>
        </a>
        <div class="fw-semibold">
          <a class="text-decoration-none text-dark" href="{% url 'frontend:product_detail' order.product_id %}">
            {{ order.product.title|default:order.product_title }}
          </a>
        </div>
      </div>
      <div class="text-end">
        {% if order.total_price %}
          <div class="fs-5 fw-bold">\{{ order.total_price|intcomma }}</div>
        {% elif order.purchase_price %}
          <div class="fs-5 fw-bold">\{{ order.purchase_price|intcomma }}</div>
        {% elif order.product.price_buy %}
          <div class="fs-5 fw-bold">\{{ order.product.price_buy|intcomma }}</div>
        {% endif %}
      </div>
    </div>

    <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
      <span class="badge bg-light text-dark">返品</span>
      <span class="badge bg-light text-dark">{{ order.quantity|default:1 }}点</span>
      {% with rs=order.return_status %}
        {% if rs == 'REQUESTED' %}
          <span class="badge bg-warning text-dark">申請中</span>
        {% elif rs == 'APPROVED' %}
          <span class="badge bg-primary">承諾済</span>
        {% elif rs == 'SHIPPED' %}
          <span class="badge bg-info">返送済み</span>
        {% elif rs == 'RECEIVED' %}
          <span class="badge bg-success">返品完了</span>
        {% elif rs == 'REJECTED' %}
          <span class="badge bg-danger">却下</span>
        {% else %}
          <span class="badge bg-secondary">返品可</span>
        {% endif %}
      {% endwith %}
    </div>

    <div class="row g-3 mt-3">
      <div class="col-md-6 small">
        <div class="mb-1">
          <span class="text-muted">購入日</span>
          {{ order.created_at|date:"Y年n月j日 H:i" }}
        </div>
        {% if order.return_requested_at %}
          <div>
            <span class="text-muted">返品申請日</span>
            {{ order.return_requested_at|date:"Y年n月j日 H:i" }}
          </div>
        {% endif %}
        {% if order.return_shipped_at %}
          <div>
            <span class="text-muted">返送日</span>
            {{ order.return_shipped_at|date:"Y年n月j日 H:i" }}
          </div>
        {% endif %}
        {% if order.return_tracking_number %}
          <div>
            <span class="text-muted">返送追跡番号</span>
            {{ order.return_tracking_number }}
          </div>
        {% endif %}
      </div>
      <div class="col-md-6 small">
        <div class="mb-1">
          <span class="text-muted">{% if mode == 'received' %}購入者{% else %}販売者{% endif %}</span>
          {% if mode == 'received' %}
            {{ order.buyer.email|default:order.buyer.username|default:order.buyer_email }}
          {% else %}
            {{ order.product.owner.email|default:order.product.owner.username|default:order.seller_email }}
          {% endif %}
        </div>
        {% if order.return_reason %}
          <div class="text-muted">申請理由:</div>
          <div class="border rounded-2 p-2 bg-light">{{ order.return_reason }}</div>
        {% endif %}
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mt-3 align-items-stretch">
      {% with rs=order.return_status %}
        {% if mode == 'mine' %}
          {% if rs == 'NONE' or rs == 'REJECTED' %}
            <form method="post" action="{% url 'frontend:return_action' %}" class="m-0 flex-grow-1 d-flex gap-2 flex-wrap">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <input type="hidden" name="purchase_id" value="{{ order.id }}">
              <input type="hidden" name="action" value="request_return">
              <input type="text" name="reason" class="form-control flex-grow-1" placeholder="理由（任意）">
              <button type="submit" class="btn btn-primary">返品申請</button>
            </form>
          {% elif rs == 'REQUESTED' %}
            <div class="flex-grow-1 small text-muted d-flex align-items-center">
              現在、返品先の承諾待ちです。
            </div>
          {% elif rs == 'APPROVED' %}
            <form method="post" action="{% url 'frontend:return_action' %}" class="m-0 flex-grow-1 d-flex gap-2 flex-wrap">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <input type="hidden" name="purchase_id" value="{{ order.id }}">
              <input type="hidden" name="action" value="ship_back">
              <input type="text" name="tracking_number" class="form-control flex-grow-1" placeholder="返送の追跡番号">
              <button type="submit" class="btn btn-primary">返送した</button>
            </form>
          {% elif rs == 'SHIPPED' %}
            <div class="flex-grow-1 small text-muted d-flex align-items-center">
              返送済みです。受領連絡をお待ちください。
            </div>
          {% elif rs == 'RECEIVED' %}
            <div class="flex-grow-1 small text-muted d-flex align-items-center">
              返品が完了しました。
            </div>
          {% else %}
            <div class="flex-grow-1 small text-muted d-flex align-items-center">
              現在のステータス: {{ rs }}
            </div>
          {% endif %}
        {% else %}
          {% if rs == 'REQUESTED' %}
            <div class="d-flex gap-2 flex-wrap flex-grow-1">
              <form method="post" action="{% url 'frontend:return_action' %}" class="m-0 flex-grow-1">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <input type="hidden" name="purchase_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="approve_return">
                <button type="submit" class="btn btn-primary w-100">返品を承諾する</button>
              </form>
              <form method="post" action="{% url 'frontend:return_action' %}" class="m-0 flex-grow-1">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <input type="hidden" name="purchase_id" value="{{ order.id }}">
                <input type="hidden" name="action" value="reject_return">
                <button type="submit" class="btn btn-outline-danger w-100">返品を却下する</button>
              </form>
            </div>
          {% elif rs == 'APPROVED' %}
            <div class="flex-grow-1 small text-muted d-flex align-items-center">
              承諾済み。購入者の返送待ちです。
            </div>
          {% elif rs == 'SHIPPED' %}
            <form method="post" action="{% url 'frontend:return_action' %}" class="m-0 flex-grow-1">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <input type="hidden" name="purchase_id" value="{{ order.id }}">
              <input type="hidden" name="action" value="receive_back">
              <button type="submit" class="btn btn-primary w-100">受領完了</button>
            </form>
          {% elif rs == 'RECEIVED' %}
            <div class="flex-grow-1 small text-muted d-flex align-items-center">
              受領済みです。
            </div>
          {% elif rs == 'REJECTED' %}
            <div class="flex-grow-1 small text-muted d-flex align-items-center">
              返品を却下しました。
            </div>
          {% else %}
            <div class="flex-grow-1 small text-muted d-flex align-items-center">
              返品申請はありません。
            </div>
          {% endif %}
        {% endif %}
      {% endwith %}
      {% if order.can_hide %}
        {% if mode == 'received' %}
          <form method="post" action="{% url 'frontend:purchase_hide_received' order.id %}" class="m-0 flex-grow-1">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn btn-outline-secondary w-100">非表示</button>
          </form>
        {% else %}
          <form method="post" action="{% url 'frontend:purchase_hide_mine' order.id %}" class="m-0 flex-grow-1">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="btn btn-outline-secondary w-100">非表示</button>
          </form>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>
