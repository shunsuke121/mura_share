from pathlib import Path
import os
from datetime import timedelta

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# åŸºæœ¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BASE_DIR = Path(__file__).resolve().parent.parent

# é–‹ç™ºä¸­ã¯ Trueã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã¯ False ã«
DEBUG = True

# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨
ALLOWED_HOSTS = ["127.0.0.1", "localhost"]

# ãã®ã¾ã¾ã§ã‚‚å‹•ãã¾ã™ãŒã€ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã‚‚æ‹¾ãˆã‚‹ã‚ˆã†ã«
SECRET_KEY = os.getenv(
    "DJANGO_SECRET_KEY",
    "django-insecure-change-this-in-production-please"
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ã‚¢ãƒ—ãƒª
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
INSTALLED_APPS = [
    # Djangoæ¨™æº–
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",

    # è¿½åŠ ï¼ˆAPI/èªè¨¼/ã‚¹ã‚­ãƒ¼ãƒ/CORS/ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
    "rest_framework",
    "django_filters",
    "corsheaders",
    "drf_spectacular",

    # è‡ªä½œã‚¢ãƒ—ãƒª
    "marketplace",
    "chat",
    "notifications",
    "accounts",
]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼ˆCORSã¯ã§ãã‚‹ã ã‘å…ˆé ­ä»˜è¿‘ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MIDDLEWARE = [
    "corsheaders.middleware.CorsMiddleware",
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]

ROOT_URLCONF = "mura_share.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [BASE_DIR / "templates"],  # å¿…è¦ãªã‚‰ templates ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    },
]

WSGI_APPLICATION = "mura_share.wsgi.application"
ASGI_APPLICATION = "mura_share.asgi.application"  # Channelså°å…¥æ™‚ã«ã‚‚ä½¿ãˆã¾ã™

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DBï¼ˆã¾ãšã¯SQLiteã§æœ€é€Ÿèµ·å‹•ã€‚PostgreSQLã«ã™ã‚‹ãªã‚‰ã“ã“ã‚’å·®ã—æ›¿ãˆï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.sqlite3",
        "NAME": BASE_DIR / "db.sqlite3",
    }
}
# ä¾‹ï¼šPostgreSQL ã«ã™ã‚‹å ´åˆ
# DATABASES = {
#     "default": {
#         "ENGINE": "django.db.backends.postgresql",
#         "NAME": os.getenv("POSTGRES_DB", "mura_share"),
#         "USER": os.getenv("POSTGRES_USER", "postgres"),
#         "PASSWORD": os.getenv("POSTGRES_PASSWORD", ""),
#         "HOST": os.getenv("POSTGRES_HOST", "localhost"),
#         "PORT": os.getenv("POSTGRES_PORT", "5432"),
#     }
# }

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
AUTH_PASSWORD_VALIDATORS = [
    {"NAME": "django.contrib.auth.password_validation.UserAttributeSimilarityValidator"},
    {"NAME": "django.contrib.auth.password_validation.MinimumLengthValidator"},
    {"NAME": "django.contrib.auth.password_validation.CommonPasswordValidator"},
    {"NAME": "django.contrib.auth.password_validation.NumericPasswordValidator"},
]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# i18n / tz
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
LANGUAGE_CODE = "ja"
TIME_ZONE = "Asia/Tokyo"
USE_I18N = True
USE_TZ = True  # DBã¯UTCã€è¡¨ç¤ºã¯Asia/Tokyoã§OK

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# é™çš„/ãƒ¡ãƒ‡ã‚£ã‚¢
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STATIC_URL = "static/"
STATIC_ROOT = BASE_DIR / "staticfiles"  # collectstatic ç”¨ï¼ˆæœ¬ç•ªï¼‰
# é–‹ç™ºã§è¿½åŠ ã®é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ããªã‚‰
# STATICFILES_DIRS = [BASE_DIR / "static"]

MEDIA_URL = "/media/"
MEDIA_ROOT = BASE_DIR / "media"

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CORSï¼ˆãƒ•ãƒ­ãƒ³ãƒˆåˆ¥ãƒ‰ãƒ¡ã‚¤ãƒ³æƒ³å®šãƒ»é–‹ç™ºã¯ã‚†ã‚‹ã‚ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CORS_ALLOW_ALL_ORIGINS = True
# æœ¬ç•ªã¯ CORS_ALLOWED_ORIGINS ã«é™å®š
# CORS_ALLOWED_ORIGINS = [
#     "https://your-frontend.example.com",
# ]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DRF / JWT / OpenAPI
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REST_FRAMEWORK = {
    "DEFAULT_SCHEMA_CLASS": "drf_spectacular.openapi.AutoSchema",
    "DEFAULT_AUTHENTICATION_CLASSES": (
        "rest_framework_simplejwt.authentication.JWTAuthentication",
    ),
    "DEFAULT_PERMISSION_CLASSES": (
        "rest_framework.permissions.IsAuthenticatedOrReadOnly",
    ),
    "DEFAULT_FILTER_BACKENDS": (
        "django_filters.rest_framework.DjangoFilterBackend",
        "rest_framework.filters.SearchFilter",
        "rest_framework.filters.OrderingFilter",
    ),
    "DEFAULT_PAGINATION_CLASS": "rest_framework.pagination.PageNumberPagination",
    "PAGE_SIZE": 20,
}

# SimpleJWTï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã§ã‚‚å‹•ãã¾ã™ã€‚æœŸé™ã‚’èª¿æ•´ã—ãŸã„å ´åˆã ã‘ï¼‰
SIMPLE_JWT = {
    "ACCESS_TOKEN_LIFETIME": timedelta(minutes=60),
    "REFRESH_TOKEN_LIFETIME": timedelta(days=7),
}

SPECTACULAR_SETTINGS = {
    "TITLE": "MURAã‚·ã‚§ã‚¢ API",
    "DESCRIPTION": "Graduation Project API (Django + DRF)",
    "VERSION": "1.0.0",
    "SERVE_INCLUDE_SCHEMA": False,
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ã“ã“ã‹ã‚‰å…ˆã¯å¿…è¦ã«å¿œã˜ã¦ï¼ˆS3, Emailç­‰ï¼‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ä¾‹ï¼šS3ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«åˆ‡æ›¿ãˆã‚‹ãªã‚‰ï¼ˆdjango-storages[boto3]ï¼‰
# INSTALLED_APPS += ["storages"]
# DEFAULT_FILE_STORAGE = "storages.backends.s3boto3.S3Boto3Storage"
# AWS_ACCESS_KEY_ID = os.getenv("AWS_ACCESS_KEY_ID", "")
# AWS_SECRET_ACCESS_KEY = os.getenv("AWS_SECRET_ACCESS_KEY", "")
# AWS_STORAGE_BUCKET_NAME = os.getenv("AWS_STORAGE_BUCKET_NAME", "")
LOGIN_URL = '/login/'
LOGIN_REDIRECT_URL = '/products/'  # ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«ç§»å‹•ã™ã‚‹ãƒšãƒ¼ã‚¸ï¼ˆãŠå¥½ã¿ã§ï¼‰
LOGOUT_REDIRECT_URL = '/login/'
STATIC_URL = "static/"
STATIC_ROOT = BASE_DIR / "staticfiles"
STATICFILES_DIRS = [BASE_DIR / "static"]  # â† è¿½åŠ 

from django.conf import settings
from django.conf.urls.static import static
from django.contrib import admin
from django.urls import path, include
from rest_framework_simplejwt.views import TokenObtainPairView, TokenRefreshView
from drf_spectacular.views import SpectacularAPIView, SpectacularSwaggerView
from rest_framework_nested import routers
from django.views.generic import RedirectView  # â† è¿½åŠ 
from marketplace.views import ProductViewSet, ProductImageViewSet, RentalViewSet, PurchaseViewSet, ReviewViewSet
from chat.views import ChatRoomViewSet, ChatMessageViewSet
from notifications.views import NotificationViewSet
from accounts.views import RegisterView, MeView
from django.urls import path, include
router = routers.DefaultRouter()
router.register(r"products", ProductViewSet, basename="products")
router.register(r"rentals", RentalViewSet, basename="rentals")
router.register(r"purchases", PurchaseViewSet, basename="purchases")
router.register(r"reviews", ReviewViewSet, basename="reviews")
router.register(r"notifications", NotificationViewSet, basename="notifications")
router.register(r"rooms", ChatRoomViewSet, basename="rooms")

# ãƒã‚¹ãƒˆ: /products/{product_id}/images/
products_router = routers.NestedDefaultRouter(router, r"products", lookup="product")
products_router.register(r"images", ProductImageViewSet, basename="product-images")

# ãƒã‚¹ãƒˆ: /rooms/{room_id}/messages/
rooms_router = routers.NestedDefaultRouter(router, r"rooms", lookup="room")
rooms_router.register(r"messages", ChatMessageViewSet, basename="room-messages")

urlpatterns = [
    path("", include(("frontend.urls", "frontend"), namespace="frontend")), # â† ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ç”»é¢
    path("admin/", admin.site.urls),

    # API
    path("api/v1/", include(router.urls)),
    path("api/v1/", include(products_router.urls)),
    path("api/v1/", include(rooms_router.urls)),

    # Auth API & Docsï¼ˆãã®ã¾ã¾ï¼‰
    path("api/v1/auth/register/", RegisterView.as_view(), name="register"),
    path("api/v1/auth/jwt/create/", TokenObtainPairView.as_view(), name="jwt-create"),
    path("api/v1/auth/jwt/refresh/", TokenRefreshView.as_view(), name="jwt-refresh"),
    path("api/v1/auth/me/", MeView.as_view(), name="me"),
    path("api/schema/", SpectacularAPIView.as_view(), name="schema"),
    path("api/docs/", SpectacularSwaggerView.as_view(url_name="schema"), name="swagger-ui"),
] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)

from django.db import models
from django.contrib.auth import get_user_model
from django.db.models.signals import post_save
from django.dispatch import receiver

User = get_user_model()


class Profile(models.Model):
    user = models.OneToOneField(
        User,
        on_delete=models.CASCADE,
        related_name="profile",
    )
    display_name = models.CharField(max_length=50, blank=True)
    phone = models.CharField(max_length=20, blank=True)
    address = models.CharField(max_length=255, blank=True)
    profile_image = models.ImageField(
        upload_to="profiles/",
        blank=True,
        null=True,
    )

    def __str__(self):
        return self.display_name or self.user.username


@receiver(post_save, sender=User)
def create_profile(sender, instance, created, **kwargs):
    if created:
        Profile.objects.create(user=instance)

# marketplace/models.py

from django.conf import settings
from django.db import models

User = settings.AUTH_USER_MODEL


class Product(models.Model):
    class Status(models.IntegerChoices):
        DRAFT    = 0, "ä¸‹æ›¸ã"
        LISTED   = 1, "å‡ºå“ä¸­"
        RENTED   = 2, "è²¸å‡ºä¸­"
        SOLD     = 3, "è²©å£²æ¸ˆ"
        ARCHIVED = 9, "ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–"

    class Availability(models.TextChoices):
        RENTAL_ONLY   = "ãƒ¬ãƒ³ã‚¿ãƒ«ã®ã¿", "ãƒ¬ãƒ³ã‚¿ãƒ«ã®ã¿"
        SALE_ONLY     = "è²©å£²ã®ã¿", "è²©å£²ã®ã¿"
        BOTH          = "ãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»è²©å£²ä¸¡æ–¹", "ãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»è²©å£²ä¸¡æ–¹"

    owner = models.ForeignKey(User, on_delete=models.CASCADE, related_name="products")
    title = models.CharField(max_length=120)
    description = models.TextField(blank=True)
    category = models.CharField(max_length=60)

    # ã“ã“ãŒã‚´ãƒªã‚´ãƒªå¼·åŒ–ã‚¾ãƒ¼ãƒ³
    availability_type = models.CharField(
        max_length=20,
        choices=Availability.choices,
        default=Availability.BOTH,
    )

    # æ–™é‡‘
    price_per_day = models.PositiveIntegerField(null=True, blank=True)  # ãƒ¬ãƒ³ã‚¿ãƒ«1æ—¥ã‚ãŸã‚Š
    price_buy = models.PositiveIntegerField(null=True, blank=True)      # è²©å£²ä¾¡æ ¼

    # ãƒ¬ãƒ³ã‚¿ãƒ«è¨­å®š
    min_rental_days = models.PositiveIntegerField(default=1)
    max_rental_days = models.PositiveIntegerField(default=30)

    # åœ¨åº«
    stock_quantity = models.PositiveIntegerField(default=1)
    available_quantity = models.PositiveIntegerField(default=1)

    # å•†å“çŠ¶æ…‹ / ã‚ªãƒ¼ãƒŠãƒ¼ãƒ¡ãƒ¢
    condition = models.CharField(max_length=30, blank=True)
    owner_notes = models.TextField(blank=True)

    status = models.IntegerField(choices=Status.choices, default=Status.LISTED)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.title


class ProductImage(models.Model):
    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name="images")
    image = models.ImageField(upload_to="products/")


class Rental(models.Model):
    class Status(models.IntegerChoices):
        REQUESTED = 0, "ç”³è«‹ä¸­"
        APPROVED  = 1, "æ‰¿èª"
        REJECTED  = 2, "å´ä¸‹"
        SHIPPED   = 3, "ç™ºé€"
        RECEIVED  = 4, "å—å–"
        RETURNED  = 5, "è¿”å´"
        COMPLETED = 6, "å®Œäº†"
        CANCELED  = 9, "ã‚­ãƒ£ãƒ³ã‚»ãƒ«"

    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name="rentals")
    renter  = models.ForeignKey(User, on_delete=models.CASCADE, related_name="rentals")
    start_date = models.DateField()
    end_date   = models.DateField()
    total_price = models.PositiveIntegerField(default=0)
    status = models.IntegerField(choices=Status.choices, default=Status.REQUESTED)
    created_at = models.DateTimeField(auto_now_add=True)


class Purchase(models.Model):
    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name="purchases")
    buyer   = models.ForeignKey(User, on_delete=models.CASCADE, related_name="purchases")
    price   = models.PositiveIntegerField()
    status  = models.CharField(max_length=20, default="paid_flag")
    created_at = models.DateTimeField(auto_now_add=True)


class Review(models.Model):
    product = models.ForeignKey(Product, on_delete=models.CASCADE, related_name="reviews")
    user    = models.ForeignKey(User, on_delete=models.CASCADE)
    rating  = models.PositiveSmallIntegerField()
    comment = models.TextField(blank=True)
    created_at = models.DateTimeField(auto_now_add=True)

{% extends "base.html" %}
{% block title %}ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« - MURAã‚·ã‚§ã‚¢{% endblock %}

{% block content %}
<div class="container py-4">

  {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} mb-2">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <div class="card shadow-sm mb-4 border-0 profile-header-card">
    <div class="card-body d-flex align-items-center">
      <div class="position-relative me-4">
        <img
          src="{% if profile.profile_image %}{{ profile.profile_image.url }}{% else %}/static/img/default_user.png{% endif %}"
          class="rounded-circle"
          width="120"
          height="120"
          alt="ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ"
        >
      </div>
      <div class="flex-grow-1">
        <h4 class="mb-1">
          {{ profile.display_name|default:user_obj.username }}
        </h4>
        <p class="text-muted mb-1">{{ user_obj.email }}</p>
        <div>
          <span class="badge bg-warning text-dark">è©•ä¾¡: 5.0</span>
          <span class="badge bg-primary">ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­</span>
          <span class="badge bg-light text-dark border">ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
        </div>
      </div>
      <div>
        {% if editing %}
          <a href="{% url 'frontend:profile' %}" class="btn btn-outline-secondary">
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </a>
        {% else %}
          <a href="{% url 'frontend:profile' %}?edit=1" class="btn btn-outline-dark">
            <i class="bi bi-pencil-square"></i> ç·¨é›†
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  <ul class="nav nav-tabs mb-4">
    <li class="nav-item"><a class="nav-link active" href="#">åŸºæœ¬æƒ…å ±</a></li>
    <li class="nav-item"><a class="nav-link" href="#">ç§ã®æŠ•ç¨¿</a></li>
    <li class="nav-item"><a class="nav-link" href="#">ãŠæ°—ã«å…¥ã‚Š</a></li>
    <li class="nav-item"><a class="nav-link" href="#">ãƒ¬ãƒ³ã‚¿ãƒ«ä¸­</a></li>
    <li class="nav-item"><a class="nav-link" href="#">å–å¼•å±¥æ­´</a></li>
  </ul>

  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <h5 class="mb-3">åŸºæœ¬æƒ…å ±</h5>

      {% if editing %}
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label text-muted">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ</label>
            <input type="file" name="profile_image" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label text-muted">
              <i class="bi bi-person me-2"></i>è¡¨ç¤ºå
            </label>
            <input
              type="text"
              name="display_name"
              class="form-control"
              value="{{ profile.display_name|default:user_obj.username }}"
              placeholder="å±±ç”° å¤ªéƒ"
            >
          </div>

          <div class="mb-3">
            <label class="form-label text-muted">
              <i class="bi bi-telephone me-2"></i>é›»è©±ç•ªå·
            </label>
            <input
              type="text"
              name="phone"
              class="form-control"
              value="{{ profile.phone }}"
              placeholder="090-1234-5678"
            >
          </div>

          <div class="mb-3">
            <label class="form-label text-muted">
              <i class="bi bi-geo-alt me-2"></i>ä½æ‰€
            </label>
            <input
              type="text"
              name="address"
              class="form-control"
              value="{{ profile.address }}"
              placeholder="æ±äº¬éƒ½æ¸‹è°·åŒº..."
            >
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              ä¿å­˜
            </button>
            <a href="{% url 'frontend:profile' %}" class="btn btn-outline-secondary">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </a>
          </div>
        </form>

      {% else %}
        <div class="mb-3">
          <label class="form-label text-muted">
            <i class="bi bi-person me-2"></i>è¡¨ç¤ºå
          </label>
          <div class="p-2 bg-light rounded">
            {{ profile.display_name|default:user_obj.username }}
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label text-muted">
            <i class="bi bi-envelope me-2"></i>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
          </label>
          <div class="p-2 bg-light rounded">
            {{ user_obj.email }}
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label text-muted">
            <i class="bi bi-telephone me-2"></i>é›»è©±ç•ªå·
          </label>
          <div class="p-2 bg-light rounded">
            {{ profile.phone|default:"æœªç™»éŒ²" }}
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label text-muted">
            <i class="bi bi-geo-alt me-2"></i>ä½æ‰€
          </label>
          <div class="p-2 bg-light rounded">
            {{ profile.address|default:"æœªç™»éŒ²" }}
          </div>
        </div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}

{% extends "base.html" %}
{% block content %}
<a class="btn btn-sm btn-outline-secondary mb-3" href="{% url 'frontend:products' %}">â† ä¸€è¦§ã«æˆ»ã‚‹</a>

<div class="row g-4">
  <div class="col-md-6">
    <div class="ratio ratio-1x1 bg-light rounded">
      {% if product.image_url %}
        <img src="{{ product.image_url }}" class="object-fit-cover rounded" alt="">
      {% endif %}
    </div>
    {% if images %}
      <div class="d-flex gap-2 mt-2">
        {% for img in images %}
          <img src="{{ img.image.url }}" class="rounded" style="width:64px;height:64px;object-fit:cover">
        {% endfor %}
      </div>
    {% endif %}
  </div>
  <div class="col-md-6">
    <h2 class="h4">{{ product.title }}</h2>
    <div class="text-muted small mb-2">{{ product.category }} / {{ product.availability_type }}</div>
    <p>{{ product.description|linebreaksbr }}</p>

    <div class="d-grid gap-2 mt-3">
      <a class="btn btn-dark" href="{% url 'frontend:messages' %}">å‡ºå“è€…ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</a>
      <a class="btn btn-outline-dark" href="{% url 'frontend:purchases' %}">è³¼å…¥ / ãƒ¬ãƒ³ã‚¿ãƒ«ç”³è«‹ã¸</a>
    </div>
  </div>
</div>

<hr class="my-4">
{% include "frontend/products/_reviews.html" %}
{% endblock %}

<div class="card h-100 border-0 shadow-sm">
  <a href="{% url 'frontend:product_detail' p.id %}">
    <div class="ratio ratio-1x1 bg-light">
      {% if p.image_url %}
        <img src="{{ p.image_url }}" class="object-fit-cover rounded-top" alt="">
      {% else %}
        <div class="d-flex align-items-center justify-content-center text-muted">ğŸ“¦</div>
      {% endif %}
    </div>
  </a>
  <div class="card-body p-2">
    {% if p.daily_price %}
      <div class="small fw-semibold">Â¥{{ p.daily_price|floatformat:0 }}/æ—¥</div>
    {% elif p.sale_price %}
      <div class="small fw-semibold">Â¥{{ p.sale_price|floatformat:0 }}</div>
    {% endif %}
    <div class="small fw-bold text-truncate">{{ p.title }}</div>
    <div class="text-muted small text-truncate">{{ p.category }}</div>
    {% if p.average_rating %}
      <div class="mt-1 text-warning small">â˜… {{ p.average_rating|floatformat:1 }}ï¼ˆ{{ p.review_count|default:0 }}ï¼‰</div>
    {% endif %}
  </div>
</div>

# accounts/views.py
from django.shortcuts import render, redirect
from django.contrib.auth import get_user_model
from django.contrib.auth.decorators import login_required
from django.contrib import messages

from rest_framework import generics, permissions, response, views

from .serializers import RegisterSerializer
from .models import Profile
from marketplace.models import Product

User = get_user_model()


class RegisterView(generics.CreateAPIView):
    queryset = User.objects.all()
    serializer_class = RegisterSerializer
    permission_classes = [permissions.AllowAny]


class MeView(views.APIView):
    permission_classes = [permissions.IsAuthenticated]

    def get(self, request):
        u = request.user
        profile, _ = Profile.objects.get_or_create(user=u)

        profile_image_url = None
        if profile.profile_image:
            try:
                profile_image_url = profile.profile_image.url
            except Exception:
                profile_image_url = None

        return response.Response({
            "id": u.id,
            "username": u.get_username(),
            "email": u.email,
            "display_name": profile.display_name or u.get_username(),
            "full_name": "",
            "phone": profile.phone,
            "address": profile.address,
            "profile_image_url": profile_image_url,
            "rating": getattr(u, "rating", None),
            "completed_rentals": getattr(u, "completed_rentals", 0),
            "favorite_products": getattr(u, "favorite_products", []),
            "role": getattr(u, "role", "user"),
        })


@login_required
def profile_view(request):
    user = request.user
    profile, _ = Profile.objects.get_or_create(user=user)

    active_tab = request.GET.get("tab", "info")
    editing = request.GET.get("edit") == "1"

    if request.method == "POST":
        display_name = request.POST.get("display_name", "").strip()
        phone = request.POST.get("phone", "").strip()
        address = request.POST.get("address", "").strip()
        profile_image = request.FILES.get("profile_image")

        original_address = profile.address

        if display_name:
            profile.display_name = display_name
        profile.phone = phone
        profile.address = address

        if profile_image is not None:
            profile.profile_image = profile_image

        profile.save()

        if not original_address and address:
            messages.success(request, "ä½æ‰€ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚ã“ã‚Œã§å•†å“ã®æŠ•ç¨¿ãƒ»ãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»è³¼å…¥ãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚")
        else:
            messages.success(request, "ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚")

        return redirect("frontend:profile")

    my_products = Product.objects.filter(owner=user)

    favorite_products = Product.objects.none()
    fav_ids = getattr(user, "favorite_products", None)
    if fav_ids:
        favorite_products = Product.objects.filter(id__in=fav_ids)

    renting_products = []
    transactions = []

    context = {
        "user_obj": user,
        "profile": profile,  # â† ã“ã‚Œã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ã§ä½¿ã†
        "active_tab": active_tab,
        "editing": editing,
        "my_products": my_products,
        "favorite_products": favorite_products,
        "renting_products": renting_products,
        "transactions": transactions,
    }
    return render(request, "frontend/profile/index.html", context)

# frontend/views.py

from django.contrib.auth.decorators import login_required
from django.shortcuts import render, redirect
from django.contrib import messages
from accounts.models import Profile

from marketplace.models import Product
from django.views.generic import ListView, DetailView, TemplateView
from django.contrib.auth.forms import UserCreationForm
from django.contrib.auth import login


class ProductListView(ListView):
    model = Product
    template_name = "frontend/products/index.html"  # ä¸€è¦§ãƒ†ãƒ³ãƒ—ãƒ¬
    context_object_name = "products"
    paginate_by = 20

    def get_queryset(self):
        # å‡ºå“ä¸­ã ã‘å‡ºã—ãŸã„ãªã‚‰ã“ã†
        return Product.objects.filter(status=Product.Status.LISTED).order_by("-created_at")


class ProductDetailView(DetailView):
    model = Product
    template_name = "frontend/products/detail.html"  # è©³ç´°ãƒ†ãƒ³ãƒ—ãƒ¬
    context_object_name = "product"

class PurchaseListView(TemplateView):
    template_name = "frontend/purchases/index.html"


class RentalListPage(TemplateView):
    template_name = "frontend/rentals/index.html"


class ReturnListPage(TemplateView):
    template_name = "frontend/returns/index.html"


class MessagesPage(TemplateView):
    template_name = "frontend/messages/index.html"


class DocumentationView(TemplateView):
    template_name = "frontend/docs/index.html"


class AdminShippingView(TemplateView):
    template_name = "frontend/admin/shipping.html"


@login_required
def product_create(request):
    user = request.user
    profile, _ = Profile.objects.get_or_create(user=user)

    # ä½æ‰€å¿…é ˆãƒã‚§ãƒƒã‚¯
    if not profile.address:
        messages.warning(request, "å•†å“ã‚’æŠ•ç¨¿ã™ã‚‹ã«ã¯ã€ã¾ãšãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã§ä½æ‰€ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚")
        return redirect("frontend:profile")

    if request.method == "POST":
        title = request.POST.get("title", "").strip()
        description = request.POST.get("description", "").strip()
        category = request.POST.get("category", "").strip()
        availability_type = request.POST.get("availability_type", "ãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»è²©å£²ä¸¡æ–¹")
        condition = request.POST.get("condition", "").strip()
        stock_quantity = request.POST.get("stock_quantity", "1")

        daily_price = request.POST.get("daily_price", "").strip()
        sale_price = request.POST.get("sale_price", "").strip()
        min_rental_days = request.POST.get("min_rental_days", "1")
        max_rental_days = request.POST.get("max_rental_days", "30")
        owner_notes = request.POST.get("owner_notes", "").strip()

        image_main = request.FILES.get("image_main")
        image_sub1 = request.FILES.get("image_sub1")
        image_sub2 = request.FILES.get("image_sub2")
        image_sub3 = request.FILES.get("image_sub3")

        errors = []

        if not image_main:
            errors.append("ãƒ¡ã‚¤ãƒ³ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")
        if not title:
            errors.append("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
        if not description:
            errors.append("å•†å“èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
        if not category:
            errors.append("ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚")
        if not condition:
            errors.append("å•†å“ã®çŠ¶æ…‹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚")

        # ãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»è²©å£²ã®å¿…é ˆãƒã‚§ãƒƒã‚¯ï¼ˆReactç‰ˆã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        if availability_type != "è²©å£²ã®ã¿" and not daily_price:
            errors.append("ãƒ¬ãƒ³ã‚¿ãƒ«ã®ã¿ã€ã¾ãŸã¯ä¸¡æ–¹ã®å ´åˆã¯ãƒ¬ãƒ³ã‚¿ãƒ«æ–™é‡‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
        if availability_type != "ãƒ¬ãƒ³ã‚¿ãƒ«ã®ã¿" and not sale_price:
            errors.append("è²©å£²ã®ã¿ã€ã¾ãŸã¯ä¸¡æ–¹ã®å ´åˆã¯è²©å£²ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")

        if errors:
            for msg in errors:
                messages.error(request, msg)

            form_data = {
                "title": title,
                "description": description,
                "category": category,
                "availability_type": availability_type,
                "condition": condition,
                "stock_quantity": stock_quantity,
                "daily_price": daily_price,
                "sale_price": sale_price,
                "min_rental_days": min_rental_days,
                "max_rental_days": max_rental_days,
                "owner_notes": owner_notes,
            }
            return render(request, "frontend/products/form.html", {"form_data": form_data})

        # æ•°å€¤å¤‰æ›
        try:
            daily_price_val = float(daily_price) if daily_price else None
            sale_price_val = float(sale_price) if sale_price else None
            min_rental_days_val = int(min_rental_days or 1)
            max_rental_days_val = int(max_rental_days or 30)
            stock_quantity_val = int(stock_quantity or 1)
        except ValueError:
            messages.error(request, "æ•°å€¤é …ç›®ã«ä¸æ­£ãªå€¤ãŒã‚ã‚Šã¾ã™ã€‚")
            form_data = {
                "title": title,
                "description": description,
                "category": category,
                "availability_type": availability_type,
                "condition": condition,
                "stock_quantity": stock_quantity,
                "daily_price": daily_price,
                "sale_price": sale_price,
                "min_rental_days": min_rental_days,
                "max_rental_days": max_rental_days,
                "owner_notes": owner_notes,
            }
            return render(request, "frontend/products/form.html", {"form_data": form_data})

        # Productä½œæˆï¼ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¯è‡ªåˆ†ã®ãƒ¢ãƒ‡ãƒ«ã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
        product = Product(
            owner=user,
            title=title,
            description=description,
            category=category,
            availability_type=availability_type,  # ãƒ¢ãƒ‡ãƒ«ã«ã“ã®ã‚«ãƒ©ãƒ ãŒã‚ã‚‹å‰æ
            daily_price=daily_price_val,
            sale_price=sale_price_val,
            min_rental_days=min_rental_days_val,
            max_rental_days=max_rental_days_val,
            stock_quantity=stock_quantity_val,
            available_quantity=stock_quantity_val,
            condition=condition,
            owner_notes=owner_notes,
            status="åˆ©ç”¨å¯èƒ½",
            views=0,
            average_rating=0,
            review_count=0,
        )

        # ç”»åƒ
        product.image_main = image_main
        if image_sub1:
            product.image_sub1 = image_sub1
        if image_sub2:
            product.image_sub2 = image_sub2
        if image_sub3:
            product.image_sub3 = image_sub3

        product.save()

        messages.success(request, "å•†å“ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸã€‚")
        return redirect("frontend:products")

    # GET ã®ã¨ãï¼šåˆæœŸå€¤ã‚’æ¸¡ã™
    form_data = {
        "availability_type": "ãƒ¬ãƒ³ã‚¿ãƒ«ãƒ»è²©å£²ä¸¡æ–¹",
        "min_rental_days": 1,
        "max_rental_days": 30,
        "stock_quantity": 1,
    }
    return render(request, "frontend/products/form.html", {"form_data": form_data})

def signup(request):
    if request.method == "POST":
        form = UserCreationForm(request.POST)
        if form.is_valid():
            user = form.save()
            login(request, user)
            return redirect("frontend:products")
    else:
        form = UserCreationForm()

    return render(request, "registration/signup.html", {"form": form})
